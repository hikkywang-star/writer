<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç‹¸æ—¥èªå…¨èƒ½å…§å®¹æŒ‡æ®ä¸­å¿ƒ v7.1 (å®Œæ•´APIç‰ˆ)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --secondary-color: #ec4899;
      --accent-color: #f59e0b;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-color: #334155;
      --border-color: #cbd5e1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP", "Microsoft JhengHei", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding-bottom: 3rem;
    }
    .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }
    
    .header { text-align: center; margin-bottom: 2.5rem; }
    .header h1 {
      font-size: 2.2rem; font-weight: 800; color: var(--text-color);
      display: flex; align-items: center; justify-content: center; gap: 1rem;
    }
    .header .badge {
      background: #10b981; color: white; padding: 0.2rem 0.6rem;
      border-radius: 99px; font-size: 0.9rem;
    }

    .api-setup-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    .api-setup-box h3 {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .api-input-group {
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .api-input-group label {
      color: white;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .api-input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.95);
      font-family: monospace;
      font-size: 0.85rem;
    }
    .api-status {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-badge.active {
      background: rgba(16, 185, 129, 0.3);
      border: 1px solid rgba(16, 185, 129, 0.5);
    }
    .status-badge.inactive {
      background: rgba(239, 68, 68, 0.3);
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .grid-layout {
      display: grid; grid-template-columns: 2fr 1.2fr; gap: 1.5rem;
    }
    @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }

    .card {
      background: var(--card-bg); border-radius: 1rem; padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem;
      border-top: 4px solid var(--primary-color);
    }
    .card.book-card { border-top-color: var(--accent-color); }
    .card.social-card { border-top-color: var(--secondary-color); }

    .card-header { 
      display: flex; align-items: center; gap: 0.5rem; 
      margin-bottom: 1rem; padding-bottom: 0.5rem; 
      border-bottom: 1px solid var(--border-color); 
    }
    .card-header h2 { font-size: 1.25rem; font-weight: 700; }
    
    label { 
      display: block; font-weight: 600; margin-bottom: 0.4rem; 
      font-size: 0.9rem; color: #475569; 
    }
    input[type="text"], textarea, select {
      width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
      border-radius: 0.5rem; font-size: 1rem; background: #f8fafc;
      transition: all 0.2s;
    }
    input:focus, textarea:focus { 
      outline: none; border-color: var(--primary-color); 
      background: white; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); 
    }
    
    .btn {
      padding: 0.6rem 1.2rem; font-size: 0.95rem; font-weight: 600; 
      border: none; border-radius: 0.5rem; cursor: pointer;
      display: inline-flex; align-items: center; gap: 0.5rem; 
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-book { background: var(--accent-color); color: white; }
    .btn-outline { 
      background: white; border: 1px solid var(--border-color); 
      color: var(--text-color); 
    }
    .btn-outline:hover { background: #f1f5f9; }
    .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }

    .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
    .tab-btn {
      padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer;
      font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; 
      margin-bottom: -2px;
    }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .output-box {
      background: #f8fafc; border: 2px dashed var(--border-color); 
      border-radius: 0.5rem; padding: 1rem; min-height: 100px; 
      max-height: 300px; overflow-y: auto; font-size: 0.9rem; 
      white-space: pre-wrap;
    }
    
    .preview-web-visual {
      background: white; border: 1px solid #e2e8f0; padding: 20px;
      margin-bottom: 15px; border-radius: 8px; max-height: 400px;
      overflow-y: auto;
    }
    .preview-web-visual h2 { 
      color: #2c3e50; border-bottom: 2px solid #6366f1; 
      padding-bottom: 10px; margin-bottom: 15px; 
    }
    .preview-web-visual .post-content p.main-body-style {
      font-size: 18px; font-weight: bold;
    }
    .preview-web-visual .post-content { line-height: 1.8; color: #333; }
    
    ruby { }
    rt { font-size: 0.6em; color: #666; }
    
    details { 
      background: #f8fafc; padding: 0.5rem 1rem; border-radius: 0.5rem; 
      margin-top: 1rem; border: 1px solid var(--border-color); 
    }
    summary { 
      cursor: pointer; font-weight: 600; display: flex; 
      align-items: center; justify-content: space-between; 
    }
    summary:hover { color: var(--primary-color); }

    .toast {
      position: fixed; top: 20px; right: 20px; background: #1e293b; 
      color: white; padding: 12px 24px; border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-100px); transition: transform 0.3s ease; 
      z-index: 9999;
    }
    .toast.show { transform: translateY(0); }
    .toast.error { background: #ef4444; }

    #coverCanvas { 
      width: 100%; max-width: 280px; height: auto; 
      border: 1px solid #ddd; border-radius: 4px; 
    }
    
    .prompt-item {
      background: white; border: 1px solid #e2e8f0;
      border-left: 4px solid #6366f1; padding: 15px;
      margin-bottom: 15px; border-radius: 4px;
    }
    .prompt-textarea {
      width: 100%; font-family: monospace; font-size: 0.85rem;
      background: #f1f5f9; padding: 10px; margin-top: 8px;
      border: 1px solid #cbd5e1; border-radius: 4px;
      color: #475569; resize: vertical;
    }
    .prompt-textarea:focus {
      outline: none; border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
  </style>
</head>
<body>

<div class="toast" id="toast">è¨Šæ¯æç¤º</div>

<div class="container">
  <div class="header">
    <img src="https://raw.githubusercontent.com/EdenHuang/Hikky_Image_Upload/main/images/1753258697046-å•†æ¨™ï¼¿æ©«å¼1.png" alt="å°ç‹¸æ—¥èª" style="height:60px; display:block; margin:0 auto 1rem auto;">
    <h1>å°ç‹¸æ—¥èªå…§å®¹æŒ‡æ®ä¸­å¿ƒ <span class="badge">v7.1 å®Œæ•´ç‰ˆ</span></h1>
    <p style="color:#64748b;">ç¤¾ç¾¤ â€¢ å®˜ç¶² â€¢ æ›¸ç¨¿ â€¢ AI ç¹ªåœ–æŒ‡ä»¤ â€” å…¨è‡ªå‹•ç”Ÿæˆ + é›²ç«¯åŒæ­¥</p>
  </div>

  <!-- API è¨­å®šå€ -->
  <div class="api-setup-box">
    <h3><i class="fas fa-cog"></i> API è¨­å®šï¼ˆè«‹å¡«å…¥æ‚¨çš„é‡‘é‘°ï¼‰</h3>
    
    <div class="api-input-group">
      <label><i class="fas fa-language"></i> Google Translate API é‡‘é‘°ï¼ˆç”¨æ–¼è‡ªå‹•ç¿»è­¯æ—¥èªâ†’è‹±èªï¼‰</label>
      <input type="text" id="apiKeyInput" placeholder="è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°ï¼ˆAIza é–‹é ­ï¼‰">
      <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 0.5rem;">
        å–å¾—æ–¹å¼ï¼š<a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #fbbf24;">Google Cloud Console</a> â†’ API å’Œæœå‹™ â†’ æ†‘è­‰
      </small>
    </div>

    <div class="api-input-group">
      <label><i class="fas fa-table"></i> Google Sheets Apps Script ç¶²å€ï¼ˆç”¨æ–¼æ›¸ç¨¿è³‡æ–™ç®¡ç†ï¼‰</label>
      <input type="text" id="sheetsUrlInput" placeholder="è²¼ä¸Šæ‚¨çš„ Apps Script ç¶²å€ï¼ˆhttps://script.google.com/...ï¼‰">
      <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 0.5rem;">
        <strong>ğŸ”— ä½ çš„æœ€æ–° Sheets ç¶²å€ï¼š</strong><br>
        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">
        https://script.google.com/macros/s/AKfycbzw2s05O0yI41o6LbDWOmMESOg6-Ax6vZ5AI09jmTQjKuBT62yurxWX11udVNPtkKkA/exec
        </code>
      </small>
    </div>

    <div class="api-input-group">
      <label><i class="fas fa-file-alt"></i> Google Docs æ–‡ä»¶ç¶²å€ï¼ˆç”¨æ–¼æ›¸ç¨¿æ’ç‰ˆé–±è®€ï¼‰</label>
      <input type="text" id="docsUrlInput" placeholder="è²¼ä¸Šæ‚¨çš„ Google Docs ç¶²å€ï¼ˆhttps://docs.google.com/document/d/...ï¼‰">
      <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 0.5rem;">
        <strong>ğŸ”— ä½ çš„ Docs ç¶²å€ï¼š</strong><br>
        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">
        https://docs.google.com/document/d/16BXhShRT7hGMx19zPkWYSvWVuSr37Dl5TLX7tFK3t30/edit
        </code><br>
        <span style="font-size: 0.85rem; margin-top: 0.3rem; display: block;">
        â„¹ï¸ å¡«å…¥å¾Œå¯ä»¥ç›´æ¥é»æ“Šã€ŒğŸ“„ Docsã€æŒ‰éˆ•é–‹å•Ÿæ–‡ä»¶
        </span>
      </small>
    </div>

    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
      <button class="btn btn-primary" onclick="saveApiSettings()" style="background: #10b981; font-size: 1rem;">
        <i class="fas fa-save"></i> å„²å­˜è¨­å®š
      </button>
      <span id="saveStatus" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;"></span>
    </div>

    <div class="api-status">
      <div class="status-badge" id="translateStatus">
        <i class="fas fa-circle"></i> ç¿»è­¯åŠŸèƒ½ï¼šæœªè¨­å®š
      </div>
      <div class="status-badge" id="sheetsStatus">
        <i class="fas fa-circle"></i> Sheets åŒæ­¥ï¼šæœªè¨­å®š
      </div>
      <div class="status-badge" id="docsStatus">
        <i class="fas fa-circle"></i> Docs åŒæ­¥ï¼šæœªè¨­å®š
      </div>
    </div>
  </div>

  <div class="grid-layout">
    <div class="main-column">
      
      <div class="card">
        <div class="card-header">
          <i class="fas fa-pen-nib" style="color:var(--primary-color)"></i>
          <h2>1. æ ¸å¿ƒå…§å®¹è¼¸å…¥</h2>
        </div>
        
        <div class="form-group">
          <label>æ•™å­¸ä¸»æ–‡</label>
          <div style="font-size:0.85rem; color:#64748b; margin-bottom:0.5rem; background:#f0f9ff; padding:0.5rem; border-radius:4px;">
            âš ï¸ <strong>æ ¼å¼è¦æ±‚ï¼š</strong><br>
            1. ç¬¬ä¸€è¡Œï¼š(a.ä¸­æ–‡é—œéµå­—)ï¼....(b.æ—¥æ–‡é—œéµå­—)<br>
            2. ä¾‹å¥è«‹ä½¿ç”¨ã€Œæ¼¢å­—(ã‹ã‚“ã˜)ã€æ ¼å¼ï¼Œç³»çµ±å°‡è‡ªå‹•è½‰ç‚ºä¸Šæ–¹æ¨™éŸ³ (Ruby)ã€‚
          </div>
          <textarea id="mainText" rows="8" placeholder="(a.ä¸­æ–‡)ï¼(b.æ—¥æ–‡)&#10;...&#10;ä¾‹1.å¯åŠ(ã­ã¼ã†)ã—ã¦ã€é›»è»Š(ã§ã‚“ã—ã‚ƒ)ã«ä¹—(ã®)ã‚Šé…(ãŠã)ã‚ŒãŸã€‚&#10;(å› ç‚ºç¡éé ­ï¼ŒéŒ¯éäº†é›»è»Šã€‚)"></textarea>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="parseKeywordsAndGenerate()">
              <i class="fas fa-magic"></i> æå–é—œéµå­—ä¸¦ç”Ÿæˆ
            </button>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
          <div>
            <label>ä¸­æ–‡é—œéµå­— (a)</label>
            <input type="text" id="keywordZH" placeholder="æå–å¾Œé¡¯ç¤ºæ–¼æ­¤">
          </div>
          <div>
            <label>æ—¥æ–‡é—œéµå­— (b)</label>
            <input type="text" id="keywordJP" placeholder="æå–å¾Œé¡¯ç¤ºæ–¼æ­¤">
          </div>
        </div>
        
        <div style="margin-top: 0.5rem;">
          <label>è‹±æ–‡é—œéµå­—ï¼ˆå°é¢èˆ‡AIç¹ªåœ–ç”¨ï¼‰<span style="color:#10b981; margin-left:8px;"><i class="fas fa-robot"></i> AI è‡ªå‹•ç¿»è­¯</span></label>
          <div style="display:flex; gap:0.5rem;">
            <input type="text" id="keywordEN" placeholder="é»æ“Šã€ŒAIç”Ÿæˆã€è‡ªå‹•ç¿»è­¯ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥" oninput="drawSiteCover(); generateImagePrompts();">
            <button class="btn btn-primary" onclick="autoGenEnglish()">
              <i class="fas fa-language"></i> AIç”Ÿæˆ
            </button>
          </div>
          <small style="color:#64748b;">*ä¿®æ”¹æ­¤è™•è‹±æ–‡æœƒåŒæ­¥æ›´æ–°å°é¢é è¦½èˆ‡AIæŒ‡ä»¤</small>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label>ä¾‹å¥å€ï¼ˆä¸€è¡Œæ—¥æ–‡ï¼Œä¸€è¡Œä¸­æ–‡ç¿»è­¯ï¼‰</label>
          <button class="btn btn-outline" onclick="extractExamplesFromMain()" style="margin-bottom:0.5rem; font-size:0.8rem;">
            é‡æ–°æå–ä¾‹å¥
          </button>
          <textarea id="exampleText" rows="6" placeholder="ç³»çµ±æœƒè‡ªå‹•æŠ“å–æ•™å­¸ä¸»æ–‡ä¸­çš„ä¾‹å¥..."></textarea>
        </div>

        <details class="prompt-details" open style="margin-top: 2rem; border-top: 2px dashed #e2e8f0; border-left:none; border-right:none; border-bottom:none;">
          <summary style="padding: 10px 0; cursor: pointer;">
            <span style="color:var(--primary-color); font-size:1.1rem; font-weight:bold;">
              <i class="fas fa-image"></i> æ•™å­¸åœ–ç‰‡ç”Ÿæˆæç¤ºè© (AI ç¹ªåœ–ç”¨)
            </span>
          </summary>
          
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem;">
            <a href="https://gemini.google.com/" target="_blank" class="btn btn-outline" style="font-size:0.85rem; padding: 0.3rem 0.8rem;">
              <i class="fas fa-external-link-alt"></i> Gemini ç”Ÿæˆåœ–ç‰‡
            </a>
            <a href="https://chatgpt.com/" target="_blank" class="btn btn-outline" style="font-size:0.85rem; padding: 0.3rem 0.8rem;">
              <i class="fas fa-external-link-alt"></i> ChatGPT ç”Ÿæˆåœ–ç‰‡
            </a>
          </div>
          
          <p style="font-size:0.85rem; color:#666; margin-bottom:1rem;">
            ç³»çµ±æœƒè‡ªå‹•æ ¹æ“šã€Œä¾‹å¥æƒ…å¢ƒã€èˆ‡ã€Œé—œéµå­—ã€ç”Ÿæˆ 5 çµ„ Promptã€‚<strong>æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹çš„æ–‡å­—æ¡†ä¸­ç›´æ¥ä¿®æ”¹æç¤ºè©å…§å®¹ã€‚</strong>
          </p>
          
          <div id="imagePromptsContainer">
            <p style="color:#94a3b8; text-align:center; padding:20px;">ç­‰å¾…ç”Ÿæˆä¸­...</p>
          </div>
        </details>

      </div>

      <div class="card social-card">
        <div class="card-header">
          <i class="fas fa-share-alt" style="color:var(--secondary-color)"></i>
          <h2>2. ç¤¾ç¾¤æ–‡æ¡ˆ (IG/FB/Threads)</h2>
        </div>
        
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('ig')">
            <i class="fab fa-instagram"></i> Instagram
          </button>
          <button class="tab-btn" onclick="switchTab('fb')">
            <i class="fab fa-facebook"></i> Facebook
          </button>
          <button class="tab-btn" onclick="switchTab('threads')">
            <i class="fab fa-threads"></i> Threads
          </button>
        </div>

        <div id="tab-ig" class="tab-content active">
          <label>Instagram è²¼æ–‡æ–‡æ¡ˆ (å« Hashtag)</label>
          <textarea id="igContent" rows="8"></textarea>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="copyToClipboard('igContent')">è¤‡è£½ IG æ–‡æ¡ˆ</button>
          </div>
        </div>

        <div id="tab-fb" class="tab-content">
          <label>Facebook ç²‰çµ²é æ–‡æ¡ˆ (å®Œæ•´ç‰ˆ + é€£çµ)</label>
          <textarea id="fbContent" rows="8"></textarea>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="copyToClipboard('fbContent')">è¤‡è£½ FB æ–‡æ¡ˆ</button>
          </div>
        </div>

        <div id="tab-threads" class="tab-content">
          <label>Threads ä¸²æ–‡ (è¼•è–„çŸ­å°)</label>
          <textarea id="threadsContent" rows="8"></textarea>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="copyToClipboard('threadsContent')">è¤‡è£½ Threads æ–‡æ¡ˆ</button>
          </div>
        </div>
      </div>

      <div class="card book-card">
        <div class="card-header">
          <i class="fas fa-book" style="color:var(--accent-color)"></i>
          <h2>3. ç¬¬å››æœ¬æ›¸æ›¸ç¨¿å€</h2>
          <div style="margin-left: auto; display: flex; gap: 0.5rem;">
            <a href="https://docs.google.com/spreadsheets/d/1CZiLuIGfFu6Nm9ToJYptLteaRXdVkq28JCs-QUYW7bc/edit" target="_blank" style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; text-decoration: none; display: flex; align-items: center; gap: 4px; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'" title="é–‹å•Ÿ Google Sheetsï¼ˆè³‡æ–™ç®¡ç†ï¼‰">
              <i class="fas fa-table"></i> Sheets
            </a>
            <a href="#" id="docsLink" target="_blank" style="background: #3b82f6; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; text-decoration: none; display: flex; align-items: center; gap: 4px; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="é–‹å•Ÿ Google Docsï¼ˆæ›¸ç¨¿æ’ç‰ˆï¼‰">
              <i class="fas fa-file-alt"></i> Docs
            </a>
          </div>
        </div>
        <p style="font-size:0.9rem; color:#666; margin-bottom:0.5rem;">æ›¸åï¼šã€Šé€™å€‹å­—ï¼Œå°ç‹¸æ—¥èªæ•™ä½ ç”¨ã€‹</p>
        
        <div class="output-box preview-html" id="bookPreview">
          <p style="color:#999; text-align:center; padding:1rem;">å°šæœªåŠ å…¥å…§å®¹</p>
        </div>
        
        <div class="btn-group" style="margin-top:1rem;">
          <button class="btn btn-book" onclick="addToBook()">
            <i class="fas fa-plus-circle"></i> åŠ å…¥æœ¬æ›¸è‰ç¨¿ + åŒæ­¥é›²ç«¯
          </button>
          <button class="btn btn-outline" onclick="exportBookToWord()">
            <i class="fas fa-file-word"></i> åŒ¯å‡º Word æª”
          </button>
        </div>
        <div style="margin-top:0.5rem; font-size:0.85rem; color:#64748b;">
          ç›®å‰å·²ç´¯ç©å–®å…ƒæ•¸ï¼š<span id="unitCount" style="font-weight:bold; color:var(--accent-color);">0</span>
          <span id="cloudStatus" style="margin-left: 10px; color: #10b981;"></span>
        </div>
        <textarea id="bookStorage" style="display:none;"></textarea>
      </div>

    </div>

    <div class="side-column">
      
      <div class="card">
        <div class="card-header">
          <i class="fas fa-globe"></i>
          <h2>4. å®˜ç¶²æ–‡ç«  & å°é¢</h2>
        </div>
        
        <canvas id="coverCanvas" width="280" height="164" style="background:#0f172a; margin-bottom:0.5rem;"></canvas>
        <div class="btn-group">
          <select id="patternStyle" onchange="drawSiteCover()" style="width:auto;">
            <option value="seigaiha">é’æµ·æ³¢</option>
            <option value="asanoha">éº»ã®è‘‰</option>
            <option value="ichimatsu">å¸‚æ¾</option>
            <option value="sakura">æ«»èŠ±</option>
            <option value="yagasuri">çŸ¢çµ£ (ç®­ç¾½ç´‹)</option>
            <option value="shippo">ä¸ƒå¯¶ (åœ“åœˆ)</option>
            <option value="kanoko">é¹¿ã®å­ (é¹¿æ–‘)</option>
          </select>
          <button class="btn btn-outline" onclick="downloadCover()">
            <i class="fas fa-download"></i> ä¸‹è¼‰å°é¢
          </button>
        </div>

        <div style="margin-top:1.5rem;">
          <label>å®˜ç¶²æ–‡ç« è¦–è¦ºé è¦½ (Preview)</label>
          <div id="webVisualPreview" class="preview-web-visual">
            <p style="color:#999; text-align:center;">å…§å®¹ç”Ÿæˆå¾Œå°‡é¡¯ç¤ºæ–¼æ­¤ (å« Ruby æ¨™éŸ³æ•ˆæœ)</p>
          </div>

          <label>å®˜ç¶² HTML (SEO å„ªåŒ–ç‰ˆ)</label>
          <textarea id="webHtml" rows="5" placeholder="è‡ªå‹•ç”¢å‡º..."></textarea>
          <button class="btn btn-primary" onclick="copyToClipboard('webHtml')" style="margin-top:0.5rem; width:100%;">
            è¤‡è£½ HTML
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-envelope"></i>
          <h2>5. é›»å­å ±åŠ©æ‰‹</h2>
        </div>
        
        <label>é›»å­å ±ä¸»æ—¨</label>
        <input type="text" id="newsletterSubject">
        
        <label style="margin-top:0.5rem;">é›»å­å ±å…§æ–‡</label>
        <textarea id="newsletterBody" rows="6"></textarea>
        
        <details>
          <summary>æœƒå“¡åå–®è™•ç† (CSV)</summary>
          <textarea id="memberCsv" rows="3" placeholder="å§“å,Email,æ¨™ç±¤..."></textarea>
          <button class="btn btn-outline" onclick="parseMembers()" style="margin-top:0.5rem; font-size:0.8rem;">
            è§£æä¸¦ç”¢ç”Ÿ BCC æ¸…å–®
          </button>
          <textarea id="bccList" rows="2" placeholder="BCC æ”¶ä»¶äºº..." style="margin-top:0.5rem;"></textarea>
        </details>
        
        <button class="btn btn-secondary" onclick="copyToClipboard('newsletterBody')" style="margin-top:0.5rem; width:100%;">
          è¤‡è£½å…§æ–‡
        </button>
      </div>

    </div>
  </div>
</div>

<script>
  // === API è¨­å®šç®¡ç† ===
  let GOOGLE_API_KEY = '';
  let GOOGLE_SHEETS_URL = '';
  let GOOGLE_DOCS_URL = '';

  function saveApiSettings() {
    GOOGLE_API_KEY = document.getElementById('apiKeyInput').value.trim();
    GOOGLE_SHEETS_URL = document.getElementById('sheetsUrlInput').value.trim();
    GOOGLE_DOCS_URL = document.getElementById('docsUrlInput').value.trim();
    
    // å„²å­˜åˆ° localStorage
    localStorage.setItem('hikky_api_key', GOOGLE_API_KEY);
    localStorage.setItem('hikky_sheets_url', GOOGLE_SHEETS_URL);
    localStorage.setItem('hikky_docs_url', GOOGLE_DOCS_URL);
    
    // æ›´æ–° Docs æŒ‰éˆ•é€£çµ
    if (GOOGLE_DOCS_URL) {
      document.getElementById('docsLink').href = GOOGLE_DOCS_URL;
    }
    
    // é¡¯ç¤ºå„²å­˜æˆåŠŸè¨Šæ¯
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.innerHTML = '<i class="fas fa-check-circle"></i> è¨­å®šå·²å„²å­˜ï¼';
    setTimeout(() => {
      saveStatus.innerHTML = '';
    }, 3000);
    
    updateApiStatus();
    showToast('âœ… API è¨­å®šå·²å„²å­˜ï¼');
  }

  function loadApiSettings() {
    const savedKey = localStorage.getItem('hikky_api_key');
    const savedSheetsUrl = localStorage.getItem('hikky_sheets_url');
    const savedDocsUrl = localStorage.getItem('hikky_docs_url');
    
    if (savedKey) {
      GOOGLE_API_KEY = savedKey;
      document.getElementById('apiKeyInput').value = savedKey;
    }
    
    // è¼‰å…¥ Sheets ç¶²å€ï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
    if (savedSheetsUrl) {
      GOOGLE_SHEETS_URL = savedSheetsUrl;
      document.getElementById('sheetsUrlInput').value = savedSheetsUrl;
    } else {
      GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzw2s05O0yI41o6LbDWOmMESOg6-Ax6vZ5AI09jmTQjKuBT62yurxWX11udVNPtkKkA/exec';
      document.getElementById('sheetsUrlInput').value = GOOGLE_SHEETS_URL;
    }
    
    // è¼‰å…¥ Docs ç¶²å€ï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
    if (savedDocsUrl) {
      GOOGLE_DOCS_URL = savedDocsUrl;
      document.getElementById('docsUrlInput').value = savedDocsUrl;
    } else {
      GOOGLE_DOCS_URL = 'https://docs.google.com/document/d/16BXhShRT7hGMx19zPkWYSvWVuSr37Dl5TLX7tFK3t30/edit';
      document.getElementById('docsUrlInput').value = GOOGLE_DOCS_URL;
    }
    
    // æ›´æ–° Docs æŒ‰éˆ•é€£çµ
    if (GOOGLE_DOCS_URL) {
      document.getElementById('docsLink').href = GOOGLE_DOCS_URL;
    }
    
    updateApiStatus();
  }

  function updateApiStatus() {
    const translateStatus = document.getElementById('translateStatus');
    const sheetsStatus = document.getElementById('sheetsStatus');
    const docsStatus = document.getElementById('docsStatus');
    
    if (GOOGLE_API_KEY && GOOGLE_API_KEY.startsWith('AIza')) {
      translateStatus.className = 'status-badge active';
      translateStatus.innerHTML = '<i class="fas fa-check-circle"></i> ç¿»è­¯åŠŸèƒ½ï¼šå·²å•Ÿç”¨';
    } else {
      translateStatus.className = 'status-badge inactive';
      translateStatus.innerHTML = '<i class="fas fa-times-circle"></i> ç¿»è­¯åŠŸèƒ½ï¼šæœªè¨­å®š';
    }
    
    if (GOOGLE_SHEETS_URL && GOOGLE_SHEETS_URL.includes('script.google.com')) {
      sheetsStatus.className = 'status-badge active';
      sheetsStatus.innerHTML = '<i class="fas fa-check-circle"></i> Sheets åŒæ­¥ï¼šå·²å•Ÿç”¨';
    } else {
      sheetsStatus.className = 'status-badge inactive';
      sheetsStatus.innerHTML = '<i class="fas fa-times-circle"></i> Sheets åŒæ­¥ï¼šæœªè¨­å®š';
    }
    
    if (GOOGLE_DOCS_URL && GOOGLE_DOCS_URL.includes('docs.google.com')) {
      docsStatus.className = 'status-badge active';
      docsStatus.innerHTML = '<i class="fas fa-check-circle"></i> Docs åŒæ­¥ï¼šå·²å•Ÿç”¨';
    } else {
      docsStatus.className = 'status-badge inactive';
      docsStatus.innerHTML = '<i class="fas fa-times-circle"></i> Docs åŒæ­¥ï¼šæœªè¨­å®š';
    }
  }

  // === å·¥å…·å‡½å¼ ===
  function showToast(msg, isError = false) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = isError ? 'toast error show' : 'toast show';
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function copyToClipboard(id) {
    let text = "";
    const el = document.getElementById(id);
    if (el) {
      text = el.value || el.innerText;
    } else {
      text = id;
    }
    
    if(!text) return showToast('æ²’æœ‰å…§å®¹å¯è¤‡è£½', true);
    navigator.clipboard.writeText(text).then(() => showToast('å·²è¤‡è£½ï¼'));
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.currentTarget.classList.add('active');
  }
  
  function convertToRuby(text) {
    const rubyRegex = /([\u3005\u4e00-\u9faf]+)[(ï¼ˆ]([ã-ã‚“ã‚¡-ãƒ³ãƒ¼]+)[)ï¼‰]/g;
    return text.replace(rubyRegex, '<ruby>$1<rt>$2</rt></ruby>');
  }

  // === Google Translate API ===
  async function translateJPtoEN(japaneseText) {
    if (!GOOGLE_API_KEY || !GOOGLE_API_KEY.startsWith('AIza')) {
      showToast('è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®š Google Translate API é‡‘é‘°', true);
      return 'Translation Error';
    }

    try {
      const response = await fetch(
        `https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_API_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            q: japaneseText,
            source: 'ja',
            target: 'en',
            format: 'text'
          })
        }
      );
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message || 'ç¿»è­¯ API éŒ¯èª¤');
      }
      
      if (data.data && data.data.translations[0]) {
        return data.data.translations[0].translatedText;
      } else {
        throw new Error('ç¿»è­¯å›æ‡‰æ ¼å¼éŒ¯èª¤');
      }
    } catch (error) {
      console.error('ç¿»è­¯éŒ¯èª¤:', error);
      showToast('ç¿»è­¯å¤±æ•—ï¼š' + error.message, true);
      return 'Translation Error';
    }
  }

  // === Google Sheets API ===
  async function saveToGoogleSheets(unitData) {
    if (!GOOGLE_SHEETS_URL || !GOOGLE_SHEETS_URL.includes('script.google.com')) {
      document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> è«‹å…ˆè¨­å®š Google Sheets ç¶²å€';
      return false;
    }

    try {
      const response = await fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(unitData)
      });
      
      document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-check-circle"></i> å·²åŒæ­¥è‡³é›²ç«¯';
      showToast('âœ… å·²åŒæ­¥è‡³ Google è©¦ç®—è¡¨ï¼');
      return true;
    } catch (error) {
      console.error('å„²å­˜éŒ¯èª¤:', error);
      document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-times-circle"></i> åŒæ­¥å¤±æ•—';
      showToast('âš ï¸ Google Sheets åŒæ­¥å¤±æ•—', true);
      return false;
    }
  }

  // === æ ¸å¿ƒé‚è¼¯ ===
  let extractedExamplesStr = []; 

  function parseKeywordsAndGenerate() {
    const text = document.getElementById('mainText').value;
    if (!text) return showToast('è«‹å…ˆè¼¸å…¥æ•™å­¸ä¸»æ–‡', true);

    const firstLine = text.split('\n')[0];
    
    const reA = /[\(ï¼ˆã€\[<]\s*[aA]\.?\s*([^)ï¼‰ã€‘\]>]+)/;
    const reB = /[\(ï¼ˆã€\[<]\s*[bB]\.?\s*([^)ï¼‰ã€‘\]>]+)/;

    const matchA = firstLine.match(reA);
    const matchB = firstLine.match(reB);

    let foundA = matchA ? matchA[1].trim() : "";
    let foundB = matchB ? matchB[1].trim() : "";

    if (foundA && foundB) {
      document.getElementById('keywordZH').value = foundA;
      document.getElementById('keywordJP').value = foundB;
      showToast('âœ… é—œéµå­—æå–æˆåŠŸï¼');
      
      autoGenEnglish(foundB);
      extractExamplesFromMain();
      generateAllContent();
    } else {
      showToast('âŒ æ ¼å¼éŒ¯èª¤ï¼æ‰¾ä¸åˆ° (a.xx) (b.xx)', true);
    }
  }

  async function autoGenEnglish(jpKey) {
    const jp = jpKey || document.getElementById('keywordJP').value;
    
    if (!jp) {
      showToast('è«‹å…ˆè¼¸å…¥æ—¥æ–‡é—œéµå­—', true);
      return;
    }
    
    const enInput = document.getElementById('keywordEN');
    enInput.value = 'ğŸ¤– AI ç¿»è­¯ä¸­...';
    
    const englishTranslation = await translateJPtoEN(jp);
    
    enInput.value = englishTranslation;
    drawSiteCover();
    generateImagePrompts();
    
    if (englishTranslation !== 'Translation Error') {
      showToast('âœ… è‹±æ–‡ç¿»è­¯å®Œæˆï¼');
    }
  }

  function extractExamplesFromMain() {
    const text = document.getElementById('mainText').value;
    const lines = text.split('\n');
    extractedExamplesStr = []; 
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      if(line.match(/^(ä¾‹|ä¾‹å¥)?[0-9ï¼-ï¼™]+[\.ï¼ã€]/) || line.match(/^ä¾‹[\.ï¼:ï¼š]/)) {
        let jpLine = line;
        let zhLine = "";
        if (lines[i + 1]) {
          const nextLine = lines[i + 1].trim();
          if (nextLine.startsWith('ï¼ˆ') || nextLine.startsWith('(') || nextLine.match(/[\u4e00-\u9fa5]/)) {
            zhLine = nextLine;
          }
        }
        extractedExamplesStr.push({ jp: jpLine, zh: zhLine });
      }
    }
    
    if(extractedExamplesStr.length > 0) {
      const textOutput = extractedExamplesStr.map(ex => `${ex.jp}\n${ex.zh}`).join('\n');
      document.getElementById('exampleText').value = textOutput;
    }
    
    generateImagePrompts(); 
  }

  function generateImagePrompts() {
    const container = document.getElementById('imagePromptsContainer');
    const jpKey = document.getElementById('keywordJP').value;
    const enKey = document.getElementById('keywordEN').value || "English Keyword";

    if (!jpKey || extractedExamplesStr.length === 0) {
      container.innerHTML = '<p style="color:#94a3b8; text-align:center;">è«‹å…ˆæå–é—œéµå­—ä¸¦ç¢ºèªæœ‰ä¾‹å¥...</p>';
      return;
    }

    let html = '';
    
    const newStyle = "ä¸»è§’ç‚ºå¯æ„›çš„äººç‰©or å‹•ç‰©è§’è‰²ï¼Œç·šæ¢ç°¡æ½”åœ“æ½¤ï¼Œæœ‰æ¸…æ™°çš„è¼ªå»“ç·šã€‚èƒŒæ™¯ä½¿ç”¨æº«æš–çš„ç±³è‰²ï¼ˆWarm Beigeï¼‰æˆ–å¥¶æ²¹è‰²ï¼Œä¸¦é»ç¶´æ·¡æ·¡çš„æ—¥å¼å‚³çµ±ç´‹æ¨£ï¼ˆå¦‚é’æµ·æ³¢ã€æ«»èŠ±ã€éº»ã®è‘‰ã€å¸‚æ¾ã€é¹¿ã®å­ã€ç®­ç¾½ç´‹....ï¼‰ã€‚è‰²å½©ä½¿ç”¨æŸ”å’Œçš„ç²‰å«©è‰²ç³»ï¼ˆPastel colorsï¼‰ã€‚ç•«é¢é…ç½®å‘ˆç¾ã€æ•™å­¸åœ–å¡ã€æˆ–ã€UI ä»‹é¢ã€é¢¨æ ¼ï¼ŒåŒ…å«åœ“è§’å°è©±æ¡†æˆ–é¸é …æŒ‰éˆ•ã€‚ä¸¦å‘ˆç¾æœ€å¤§ç•«é¢ï¼Œä½†ä¸è¶…å‡ºåŒ¡ç·š";

    extractedExamplesStr.slice(0, 5).forEach((ex, index) => {
      let cleanSentenceForAI = ex.jp.replace(/^(ä¾‹|ä¾‹å¥)?[0-9ï¼-ï¼™]+[\.ï¼:ï¼šã€\s]*/, ''); 
      cleanSentenceForAI = cleanSentenceForAI.replace(/\([^\)]+\)/g, '').replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, '');

      const promptText = `ç”Ÿæˆä¸€å¼µIGç”¨ 1080*1080 px æ’ç•«ï¼Œç•«é¢ä¸»é¡Œå‘ˆç¾ã€Œ${cleanSentenceForAI}ã€é€™å€‹æƒ…å¢ƒã€‚åœ–ç‰‡ä¸Šæ–¹æ”¾ä¸Šé—œéµå­—ã€Œ${jpKey}ã€ä¸éœ€è¦é¡¯ç¤ºã€Œä¸­æ–‡æˆ–æ—¥æ–‡é—œéµå­—ã€ç­‰å­—æ¨£ï¼Œä¸‹æ–¹æœ‰ç›¸å‘¼æ‡‰çš„è‹±èªå°å­—ã€Œ${enKey}ã€ã€‚åœ–ç‰‡ä¸‹æ–¹æœ‰ã€Œå°ç‹¸æ—¥èªã€å­—æ¨£ã€‚æ³¨æ„ã€Œå°ç‹¸æ—¥èªã€å­—é«”ä¸è¦å¯«éŒ¯ã€‚é¢¨æ ¼è¦æ±‚ï¼š${newStyle}`;

      html += `
        <div class="prompt-item">
          <div style="font-weight:bold; color:#4a5568; font-size:0.9rem;">
            <i class="fas fa-quote-left" style="color:#cbd5e1;"></i> ä¾‹å¥æƒ…å¢ƒï¼š${cleanSentenceForAI}
          </div>
          <textarea class="prompt-textarea" id="prompt-${index}" rows="6">${promptText}</textarea>
          
          <button class="btn btn-outline" style="margin-top:10px; font-size:0.8rem;" onclick="copyToClipboard('prompt-${index}')">
            <i class="fas fa-copy"></i> è¤‡è£½ç”ŸæˆæŒ‡ä»¤
          </button>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function generateAllContent() {
    const zh = document.getElementById('keywordZH').value;
    const jp = document.getElementById('keywordJP').value;
    const main = document.getElementById('mainText').value;
    const ex = document.getElementById('exampleText').value;
    const url = "https://www.hikky.com.tw";
    
    if(!zh || !jp) return;

    const mainBody = main.substring(main.indexOf('\n') + 1).trim();

    const igText = `${mainBody}\n\n--\n\nğŸ“Œ é€™æ¬¡å­¸åˆ°çš„æ—¥èªï¼š\n${jp}\n(${zh})\n\n--\n\nã€ä¾‹å¥ã€‘\n${ex}\n\n--\nå–œæ­¡é€™å€‹æ•™å­¸å—ï¼ŸæŒ‰è®šæ”¶è—èµ·ä¾†ï¼\n\n#å°ç‹¸æ—¥èª #æ—¥èªæ•™å­¸ #æ—¥æ–‡å–®å­— #é€™å€‹å­—å°ç‹¸æ—¥èªæ•™ä½ ç”¨ #${jp} #æ—¥æœ¬èªå‹‰å¼·`;
    document.getElementById('igContent').value = igText;

    const fbText = `ã€${zh}ã€‘æ—¥èªæ€éº¼èªªï¼Ÿ\n\nå—¨ï¼æˆ‘æ˜¯å°ç‹¸è€å¸«ã€‚\nä»Šå¤©è¦æ•™å¤§å®¶ã€Œ${jp}ã€é€™å€‹ç”¨æ³•ï¼\n\n${mainBody}\n\nğŸ‘‡ æ›´å¤šå®Œæ•´ä¾‹å¥èˆ‡è©³ç´°è§£èªªï¼Œè«‹çœ‹å®˜ç¶²ï¼š\n${url}\n\n--\nä¾‹å¥ç·´ç¿’ï¼š\n${ex}\n\n--\n#å°ç‹¸æ—¥èª #ç·šä¸Šèª²ç¨‹ #æ—¥æ–‡æª¢å®š #å­¸æ—¥èª`;
    document.getElementById('fbContent').value = fbText;

    const threadsText = `æ—¥èªå°æ•™å®¤ ğŸ‡¯ğŸ‡µ\n\nã€Œ${zh}ã€æ—¥èªæ˜¯ã€Œ${jp}ã€å–”ï¼\n\n${mainBody.substring(0, 60)}...\n\n(è©³ç´°ä¾‹å¥ä¸‹æ”¶ ğŸ‘‡)\n\n#é€™å€‹å­—å°ç‹¸æ—¥èªæ•™ä½ ç”¨`;
    document.getElementById('threadsContent').value = threadsText;

    generateWebHtml(zh, jp, mainBody, ex);

    const mailSubject = `ã€å°ç‹¸æ—¥èªã€‘${zh} - æ—¥èªæ€éº¼èªªï¼Ÿ`;
    const mailBody = `Hi å„ä½åŒå­¸å¥½ï¼Œæˆ‘æ˜¯å°ç‹¸è€å¸«ï¼\n\nä»Šå¤©è¦åˆ†äº«çš„å–®å­—æ˜¯ï¼š${jp} (${zh})\n\n${mainBody}\n\nã€é‡é»ä¾‹å¥ã€‘\n${ex}\n\nç¥ å­¸ç¿’æ„‰å¿«ï¼\n\nå°ç‹¸è€å¸«\n${url}`;
    document.getElementById('newsletterSubject').value = mailSubject;
    document.getElementById('newsletterBody').value = mailBody;

    drawSiteCover();
  }

  function generateWebHtml(zh, jp, mainBody, ex) {
    let processedMainBody = mainBody.replace(/\n/g, '<br>');
    processedMainBody = convertToRuby(processedMainBody);

    let safeEx = ex.replace(/\n/g, '<br>');
    safeEx = convertToRuby(safeEx);
    
    const html = `
<article class="hikky-post">
  <h2>ã€${zh}ã€‘æ—¥èªæ€éº¼èªªï¼Ÿâ€”ã€Œ${jp}ã€</h2>
  <div class="post-content">
    <p class="main-body-style"><span style="font-size:18px;"><strong>${processedMainBody}</strong></span></p>
    
    <h3 style="background:#f0fdf4; padding:0.5rem; border-left:4px solid #10b981; margin-top:2rem;">ä¼šè©±ä¾‹æ–‡ (å¯¦ç”¨ä¾‹å¥)</h3>
    <div class="examples" style="padding:15px; font-size:1.1rem; line-height:1.8;">
      ${safeEx}
    </div>

    <hr style="margin:2rem 0;">
    <p style="background:#f8fafc; padding:1rem; border-radius:0.5rem;">
      <strong>å»¶ä¼¸é–±è®€ï¼š</strong><br>
      âœ¿ <a href="https://www.books.com.tw/products/0010950783?sloc=main" target="_blank">ã€Šæ—¥èª50éŸ³å®Œå…¨è‡ªå­¸æ‰‹å†Šã€‹</a><br>
      âœ¿ <a href="https://www.books.com.tw/products/0011009917" target="_blank">ã€Šå°ç‹¸æ—¥èªè§€å¿µæ–‡æ³•æ›¸ã€‹</a><br>
      âœ¿ <a href="https://www.pressplay.cc/project/1BE389CCCB3B6D99624B7E88D2DE1379/about" target="_blank">æ²ˆæµ¸å¼æ—¥èªå£èªªè¨“ç·´èª²</a>
    </p>
  </div>
</article>
    `;
    document.getElementById('webHtml').value = html.trim();
    document.getElementById('webVisualPreview').innerHTML = html;
  }

  let bookUnits = [];

  async function addToBook() {
    const zh = document.getElementById('keywordZH').value;
    const jp = document.getElementById('keywordJP').value;
    const main = document.getElementById('mainText').value;
    const ex = document.getElementById('exampleText').value;

    if(!zh) return showToast('è«‹å…ˆç”Ÿæˆå…§å®¹', true);
    
    const mainBody = main.substring(main.indexOf('\n') + 1).trim();

    const unitHTML = `
      <div class="book-unit" style="margin-bottom:2rem; border-bottom:1px dashed #ccc; padding-bottom:1rem;">
        <h2 style="color:#ec4899;">Unit ${bookUnits.length + 1}ï¼š${zh}ï¼ˆ${jp}ï¼‰</h2>
        <p><strong>ã€è§£èªªã€‘</strong></p>
        <p>${mainBody.replace(/\n/g, '<br>')}</p>
        <p><strong>ã€ä¾‹å¥ã€‘</strong></p>
        <p>${ex.replace(/\n/g, '<br>')}</p>
        <p style="font-size:0.8rem; color:#888;">[æ›¸åæ¨™ç±¤ï¼šé€™å€‹å­—ï¼Œå°ç‹¸æ—¥èªæ•™ä½ ç”¨]</p>
      </div>
    `;

    bookUnits.push(unitHTML);
    document.getElementById('unitCount').textContent = bookUnits.length;
    
    document.getElementById('bookPreview').innerHTML = bookUnits.join('');
    document.getElementById('bookStorage').value = `
      <html><body>
      <h1 style="text-align:center;">ã€Šé€™å€‹å­—ï¼Œå°ç‹¸æ—¥èªæ•™ä½ ç”¨ã€‹æ›¸ç¨¿</h1>
      <hr>
      ${bookUnits.join('<br style="page-break-after:always;">')}
      </body></html>
    `;
    
    const unitData = {
      unitNumber: bookUnits.length,
      keywordZH: zh,
      keywordJP: jp,
      mainBody: mainBody,
      examples: ex
    };
    
    await saveToGoogleSheets(unitData);
    
    showToast('âœ… å·²åŠ å…¥æ›¸ç¨¿ï¼');
  }

  function exportBookToWord() {
    const content = document.getElementById('bookStorage').value;
    if(!content) return showToast('æ›¸ç¨¿æ˜¯ç©ºçš„', true);
    
    const blob = new Blob(['\ufeff', content], {
      type: 'application/msword'
    });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `å°ç‹¸æ—¥èªæ›¸ç¨¿_å…±${bookUnits.length}å–®å…ƒ.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function drawSiteCover() {
    const canvas = document.getElementById('coverCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const jp = document.getElementById('keywordJP').value || 'æ—¥æ–‡é—œéµå­—';
    const en = document.getElementById('keywordEN').value || '';
    const pattern = document.getElementById('patternStyle').value;

    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0,0,w,h);
    
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;

    if(pattern === 'seigaiha') { 
      for(let y=0; y<h; y+=20) for(let x=0; x<w; x+=30) { 
        ctx.beginPath(); ctx.arc(x,y,15,0,Math.PI*2); ctx.stroke(); 
      }
    } else if (pattern === 'ichimatsu') { 
      for(let y=0; y<h; y+=20) for(let x=0; x<w; x+=20) { 
        if((x/20+y/20)%2===0) ctx.fillRect(x,y,20,20); 
      }
    } else if (pattern === 'sakura') { 
      ctx.fillStyle = 'rgba(236, 72, 153, 0.2)';
      for(let i=0; i<15; i++) {
        const x = Math.random()*w; 
        const y = Math.random()*h;
        ctx.beginPath(); 
        ctx.arc(x,y, Math.random()*6+2, 0, Math.PI*2); 
        ctx.fill();
      }
    } else if (pattern === 'asanoha') { 
      ctx.beginPath();
      for(let y=-20; y<h; y+=40) {
        ctx.moveTo(0, y); ctx.lineTo(w, y);
        for(let x=0; x<w; x+=30) {
          ctx.moveTo(x, y); ctx.lineTo(x+15, y+40);
          ctx.moveTo(x+15, y+40); ctx.lineTo(x+30, y);
        }
      }
      ctx.stroke();
    } else if (pattern === 'yagasuri') { 
      ctx.beginPath();
      for(let x=0; x<w; x+=20) {
        ctx.moveTo(x, 0); ctx.lineTo(x, h);
        for(let y=0; y<h; y+=20) {
          if((x/20)%2===0) { 
            ctx.moveTo(x,y); ctx.lineTo(x+10, y+10); 
          } else { 
            ctx.moveTo(x,y+10); ctx.lineTo(x+10, y); 
          }
        }
      }
      ctx.stroke();
    } else if (pattern === 'shippo') { 
      for(let y=0; y<h; y+=30) for(let x=0; x<w; x+=30) {
        ctx.beginPath(); ctx.arc(x,y,15,0,Math.PI*2); ctx.stroke();
      }
    } else if (pattern === 'kanoko') { 
      for(let y=0; y<h; y+=15) for(let x=0; x<w; x+=15) {
        if((x+y)%2===0) { 
          ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill(); 
        }
      }
    }

    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.font = 'bold 22px "Noto Sans JP", sans-serif';
    ctx.fillText(jp, w/2, h/2 - 5);
    
    ctx.fillStyle = '#ec4899'; 
    ctx.font = '14px sans-serif';
    ctx.fillText(en.toUpperCase(), w/2, h/2 + 25);
    
    ctx.beginPath();
    ctx.moveTo(40, h/2 + 10); 
    ctx.lineTo(w-40, h/2 + 10);
    ctx.strokeStyle = '#ec4899';
    ctx.stroke();
  }

  function downloadCover() {
    const link = document.createElement('a');
    link.download = 'hikky_cover.png';
    link.href = document.getElementById('coverCanvas').toDataURL();
    link.click();
  }
  
  function parseMembers() {
    const raw = document.getElementById('memberCsv').value;
    const emails = raw.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
    if(emails) {
      document.getElementById('bccList').value = emails.join(', ');
      showToast(`æŠ“å–åˆ° ${emails.length} å€‹ Email`);
    } else {
      showToast('æ‰¾ä¸åˆ° Email', true);
    }
  }

  window.onload = function() {
    loadApiSettings();
    drawSiteCover();
  }
</script>
</body>
</html>
