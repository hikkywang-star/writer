<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ–¹æ ¼å­é¢¨æ ¼ï½œæœ¬åœ°éƒ¨è½æ ¼ç·¨è¼¯å™¨ Proï¼ˆå«å…¬é–‹é è·¯ç”±ï¼‰</title>

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-dark.min.css" />

  <!-- Free fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --app-bg:#f6f7fb;
      --panel-bg:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --primary:#2563eb;
      --pink:#db2777;
      --danger:#ef4444;

      --content-font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif;
      --content-font-size:16px;
      --content-line-height:1.85;

      --topbar-h:60px;
      --side-w:300px;
      --toc-w:300px;

      --radius:16px;
      --shadow: 0 10px 24px rgba(2,6,23,.08);

      /* ğŸ”´ æ–°å¢ï¼šé ‚éƒ¨å®‰å…¨è·é›¢ï¼ˆé¿å…åŠŸèƒ½åˆ—è²¼å¤ªä¸Šé¢é»ä¸åˆ°ï¼‰ */
      --safeTop: 18px;
      --safeTop: max(18px, env(safe-area-inset-top));
    }

    body{
      margin:0;
      /* ğŸ”´ æ–°å¢ï¼šæ•´å€‹é é¢å¾€ä¸‹ç•™å®‰å…¨è·é›¢ï¼ˆä¸æ”¹çµæ§‹ï¼‰ */
      padding-top: var(--safeTop);
      box-sizing: border-box;

      background:var(--app-bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
    }

    /* ---- topbar ---- */
    .topbar{
      height:var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      position:sticky;

      /* ğŸ”´ ä¿®æ”¹ï¼šå¾ top:0 æ”¹æˆå®‰å…¨è·é›¢ */
      top:var(--safeTop);

      z-index:30;
      gap:12px;
      box-sizing:border-box;
    }
    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      color:var(--text);
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{ border-color:#cbd5e1; }
    .btn.primary{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }
    .btn.soft{
      background:#eff6ff;
      border-color:#bfdbfe;
      color:#1d4ed8;
    }
    .btn.danger{
      background:#fff;
      border-color:#fecaca;
      color:var(--danger);
    }

    .pill{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      border:1px solid #c7d2fe;
      white-space:nowrap;
      font-weight:900;
    }
    .pill.gray{
      background:#f1f5f9;
      border-color:#e2e8f0;
      color:#334155;
    }
    .pill.green{
      background:#ecfdf5;
      border-color:#a7f3d0;
      color:#065f46;
    }
    .pill.yellow{
      background:#fffbeb;
      border-color:#fde68a;
      color:#92400e;
    }

    .title-input{
      width:min(520px, 40vw);
      max-width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      min-width:180px;
    }

    .select{
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      background:#fff;
      font-weight:900;
      color:var(--text);
      cursor:pointer;
    }

    .fontSizeBox{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    .fontSizeBox .n{
      width:36px;
      text-align:center;
      font-weight:1000;
      font-size:12px;
      color:var(--muted);
    }

    /* ---- layout ---- */
    .layout{
      /* ğŸ”´ ä¿®æ”¹ï¼šé«˜åº¦æ‰£æ‰ safeTopï¼Œé¿å…æ•´é«”å¤šå‡ºä¸€æˆªé€ æˆå¡ä½/é»ä¸åˆ° */
      height:calc(100vh - var(--topbar-h) - var(--safeTop));
      display:flex;
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }

    .panel{
      background:var(--panel-bg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .sidebar{ width:var(--side-w); }
    .toc{ width:var(--toc-w); }
    .editorArea{ flex:1; }

    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fff;
    }
    .panelHead .h{
      font-weight:1000;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* ---- post list ---- */
    .filters{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
    }
    .tab.active{
      color:var(--text);
      border-color:#bfdbfe;
      background:#eff6ff;
    }

    .postList{
      list-style:none;
      margin:0;
      padding:8px;
      overflow:auto;
      flex:1;
    }

    .postItem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .postItem:hover{ background:#f8fafc; }
    .postItem.active{
      border-color:#bfdbfe;
      background:#eff6ff;
    }
    .postItem .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .postItem .t{
      font-weight:1000;
      font-size:13px;
      line-height:1.35;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      min-width:0;
    }
    .postItem .meta{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-weight:1000;
      white-space:nowrap;
    }
    .badge.draft{ background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .badge.pub{ background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }

    /* ---- editor ---- */
    #editorWrap{
      flex:1;
      min-height:0;
    }

    /* typography for editor & preview */
    .toastui-editor-md-container .ProseMirror,
    .toastui-editor-ww-container .ProseMirror,
    .toastui-editor-contents{
      font-family: var(--content-font-family) !important;
      font-size: var(--content-font-size) !important;
      line-height: var(--content-line-height) !important;
    }

    /* ---- callout style (works in preview + reader + public) ---- */
    .toastui-editor-contents .callout,
    .callout{
      border:1px solid var(--border);
      border-left-width:6px;
      border-radius:14px;
      padding:12px 14px;
      margin:14px 0;
      background:#f8fafc;
    }
    .callout .calloutTitle{
      font-weight:1000;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .callout.tip{ border-left-color:#10b981; background:#ecfdf5; }
    .callout.note{ border-left-color:#2563eb; background:#eff6ff; }
    .callout.warn{ border-left-color:#f59e0b; background:#fffbeb; }
    .callout.quote{ border-left-color:#64748b; background:#f1f5f9; }

    /* ---- toc ---- */
    .tocList{
      padding:8px 10px 14px;
      overflow:auto;
      flex:1;
    }
    .tocItem{
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
      border:1px solid transparent;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tocItem:hover{ background:#f8fafc; }
    .tocItem.active{ background:#eff6ff; border-color:#bfdbfe; }
    .tocLevel{
      font-size:11px;
      color:var(--muted);
      font-weight:1000;
      flex:0 0 auto;
    }
    .tocText{
      font-weight:1000;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex:1;
    }

    /* ---- overlay / drawer ---- */
    .mask{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:60;
      align-items:stretch;
      justify-content:flex-end;
    }
    .drawer{
      width:min(480px, 94vw);
      background:#fff;
      border-left:1px solid var(--border);
      padding:14px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drawer h3{
      margin:0;
      font-size:16px;
      font-weight:1100;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
    }
    .field input, .field textarea, .field select{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
      font-family: var(--content-font-family);
      font-weight:800;
    }
    .field textarea{ min-height:90px; resize:vertical; }

    .drawerActions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid var(--border);
    }

    /* cover uploader */
    .coverBox{
      border:2px dashed #cbd5e1;
      border-radius:16px;
      padding:12px;
      background:#f8fafc;
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .coverBox.drag{
      border-color: var(--primary);
      background:#eff6ff;
    }
    .coverPreview{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#fff;
    }
    .coverPreview img{
      width:100%;
      display:block;
    }
    .coverHint{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      line-height:1.5;
    }

    /* full overlay */
    .overlayMask{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.70);
      display:none;
      z-index:70;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }
    .overlayPanel{
      width:min(980px, 100%);
      height:min(92vh, 860px);
      background:#ffffff;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .overlayHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .overlayHead .h{
      font-weight:1100;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .overlayBody{
      padding:14px;
      overflow:auto;
      flex:1;
      box-sizing:border-box;
    }

    /* reader */
    .readerCover{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      margin-bottom:14px;
      background:#f8fafc;
    }
    .readerCover img{ width:100%; display:block; }
    .readerTitle{
      margin:0 0 8px 0;
      font-size:28px;
      line-height:1.2;
      font-weight:1100;
    }
    .readerMeta{
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      margin-bottom:12px;
      line-height:1.5;
    }
    .readerContent{
      font-family: var(--content-font-family);
      font-size: var(--content-font-size);
      line-height: var(--content-line-height);
    }
    .readerContent img{ max-width:100%; border-radius:12px; }
    .readerContent pre{ overflow:auto; padding:12px; border-radius:12px; background:#0b1220; color:#e5e7eb; }

    /* share generator */
    .shareGrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ flex-direction:column; height:auto; }
      .sidebar, .toc{ width:auto; }
      .shareGrid{ grid-template-columns: 1fr; }
    }
    .sharePreview{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#0b1220;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:240px;
    }
    .sharePreview img{ width:100%; display:block; }
    .shareBtns{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .smallHint{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      line-height:1.5;
    }

    /* versions list */
    .verList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .verItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .verItem .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .verItem .t{
      font-weight:1100;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 560px;
    }
    .verItem .m{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .verItem .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---- PUBLIC PAGE (ç´”å‰ç«¯è·¯ç”±) ---- */
    #appPublic{
      display:none;
      /* ğŸ”´ ä¿®æ”¹ï¼šé¿å… body padding-top é€ æˆ public å¤šå‡ºä¸€æˆª */
      min-height:calc(100vh - var(--safeTop));
    }
    .publicTop{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 12px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      position:sticky;

      /* ğŸ”´ ä¿®æ”¹ï¼šå¾ top:0 æ”¹æˆå®‰å…¨è·é›¢ */
      top:var(--safeTop);

      z-index:35;
      box-sizing:border-box;
    }
    .publicTop .left, .publicTop .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .publicWrap{
      max-width: 920px;
      margin: 18px auto 64px;
      padding: 0 14px;
      box-sizing:border-box;
    }
    .publicCard{
      background:var(--panel-bg);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .publicCover{
      width:100%;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
    }
    .publicCover img{
      width:100%;
      display:block;
      max-height: 420px;
      object-fit: cover;
      object-position: center;
    }
    .publicBody{
      padding:16px 18px 18px;
    }
    .publicTitle{
      margin:0 0 10px;
      font-size:32px;
      line-height:1.18;
      font-weight:1100;
      letter-spacing:.2px;
    }
    .publicMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom: 14px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      line-height:1.5;
    }
    .publicDesc{
      margin: 0 0 14px;
      font-weight:900;
      color:var(--text);
      opacity:.92;
      line-height:1.7;
    }
    #publicViewer{
      padding-top: 6px;
    }
    .publicNotice{
      padding:16px 18px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff7ed;
      border-color:#fed7aa;
      color:#9a3412;
      font-weight:1000;
      line-height:1.6;
    }

    /* dark mode shell */
    body.app-dark{
      --app-bg:#0b1220;
      --panel-bg:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2a44;
      background:var(--app-bg);
      color:var(--text);
    }
    body.app-dark .topbar{ background:rgba(15,23,42,.78); }
    body.app-dark .btn,
    body.app-dark .select,
    body.app-dark .title-input,
    body.app-dark .fontSizeBox{
      background:#0f172a;
      border-color:#1f2a44;
      color:var(--text);
    }
    body.app-dark .pill.gray{ background:#111c33; border-color:#1f2a44; color:#e5e7eb; }
    body.app-dark .panelHead{ background:#0f172a; }
    body.app-dark .postItem:hover{ background:#111c33; }
    body.app-dark .postItem.active{ background:#0b2a55; border-color:#1d4ed8; }
    body.app-dark .tocItem:hover{ background:#111c33; }
    body.app-dark .tocItem.active{ background:#0b2a55; border-color:#1d4ed8; }
    body.app-dark .drawer{ background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    body.app-dark .drawerActions{ border-color:#1f2a44; }
    body.app-dark .field input, body.app-dark .field textarea, body.app-dark .field select{
      background:#0f172a; color:#e5e7eb; border-color:#1f2a44;
    }
    body.app-dark .coverBox{ background:#0f172a; border-color:#334155; }
    body.app-dark .coverBox.drag{ border-color:#60a5fa; background:#0b2a55; }
    body.app-dark .overlayPanel{ background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    body.app-dark .overlayHead{ background:#0f172a; border-color:#1f2a44; }
    body.app-dark .overlayBody{ background:#0b1220; }
    body.app-dark .verItem{ border-color:#1f2a44; }

    body.app-dark .publicTop{ background:rgba(15,23,42,.78); }
    body.app-dark .publicCover{ background:#0b1220; }
    body.app-dark .publicNotice{ background:#2a1606; border-color:#7c2d12; color:#fdba74; }
  </style>
</head>

<body>
  <!-- =========================
       EDITOR APP (default)
       ========================= -->
  <div id="appEditor">
    <header class="topbar">
      <div class="left">
        <button class="btn primary" id="btnNew">ï¼‹ æ–°æ–‡ç« </button>
        <button class="btn danger" id="btnDelete">åˆªé™¤</button>

        <button class="btn" id="btnToggleStatus" title="åˆ‡æ›è‰ç¨¿ / ç™¼ä½ˆ">
          <span id="statusText">è‰ç¨¿</span>
        </button>

        <!-- âœ… æ–°å¢ï¼šå…¬é–‹é  / è¤‡è£½å…¬é–‹é€£çµ -->
        <button class="btn soft" id="btnOpenPublic" title="å·²ç™¼ä½ˆæ–‡ç« æ‰æœƒé¡¯ç¤ºå…§å®¹">å…¬é–‹é </button>
        <button class="btn" id="btnCopyPublic" title="è¤‡è£½å…¬é–‹é é€£çµ">è¤‡è£½é€£çµ</button>

        <input class="title-input" id="titleInput" placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œâ€¦" />
        <span class="pill" id="saveState">å·²å„²å­˜</span>
      </div>

      <div class="right">
        <select class="select" id="fontSelect" title="å­—é«”ï¼ˆå…ä»˜è²»å·²æˆæ¬Šå­—é«”ï¼‰">
          <option value='"Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif'>Noto Sans TCï¼ˆç©©ï¼‰</option>
          <option value='"Noto Serif TC", serif'>Noto Serif TCï¼ˆæ–‡ç« æ„Ÿï¼‰</option>
          <option value='"Zen Maru Gothic", "Noto Sans JP", sans-serif'>Zen Maru Gothicï¼ˆåœ“æ½¤ï¼‰</option>
          <option value='"M PLUS Rounded 1c", "Noto Sans TC", sans-serif'>M PLUS Rounded 1cï¼ˆå¯æ„›ï¼‰</option>
          <option value='"Noto Sans JP", sans-serif'>Noto Sans JPï¼ˆæ—¥æ–‡å­—ï¼‰</option>
          <option value='"Inter", system-ui, sans-serif'>Interï¼ˆè‹±æ•¸æ¼‚äº®ï¼‰</option>
        </select>

        <div class="fontSizeBox" title="å­—ç´š">
          <button class="btn" style="padding:6px 8px;border-radius:12px;" id="btnSmaller">A-</button>
          <span class="n" id="fontSizeLabel">16</span>
          <button class="btn" style="padding:6px 8px;border-radius:12px;" id="btnBigger">A+</button>
        </div>

        <button class="btn" id="btnMode" title="åˆ‡æ› Markdown / WYSIWYG">Markdown</button>
        <button class="btn" id="btnTheme" title="åˆ‡æ›æ·±æ·ºè‰²">ğŸŒ™ æ·±è‰²</button>

        <!-- ä½ è¦æ±‚ï¼šä¸Šæ–¹åˆ—ä¿ç•™ -->
        <button class="btn soft" id="btnReading" title="æ‰“é–‹é–±è®€æ¨¡å¼ä¸¦æ›´æ–°å…§å®¹">æ›´æ–°é–±è®€æ¨¡å¼</button>

        <button class="btn" id="btnSettings" title="æ–‡ç« è¨­å®šï¼ˆå«å°é¢ä¸Šå‚³ï¼‰">æ–‡ç« è¨­å®š</button>
        <button class="btn" id="btnShare" title="ç”¢ç”Ÿç¤¾ç¾¤åˆ†äº«åœ–">åˆ†äº«åœ–</button>
        <button class="btn" id="btnVersions" title="ç‰ˆæœ¬ç´€éŒ„ / å¾©åŸ">ç‰ˆæœ¬</button>
        <button class="btn" id="btnCmds" title="Slash æŒ‡ä»¤æ¸…å–®">æŒ‡ä»¤ /</button>

        <button class="btn" id="btnExportJson" title="åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ JSON">åŒ¯å‡ºJSON</button>
        <button class="btn" id="btnImportJson" title="åŒ¯å…¥ JSON">åŒ¯å…¥JSON</button>
      </div>
    </header>

    <main class="layout">
      <aside class="panel sidebar">
        <div class="panelHead">
          <div class="h">æ–‡ç« æ¸…å–® <span class="pill gray" id="postCount">0 ç¯‡</span></div>
          <div class="filters">
            <span class="tab active" data-filter="all">å…¨éƒ¨</span>
            <span class="tab" data-filter="draft">è‰ç¨¿</span>
            <span class="tab" data-filter="published">å·²ç™¼ä½ˆ</span>
          </div>
        </div>
        <ul class="postList" id="postList"></ul>
      </aside>

      <section class="panel editorArea">
        <div id="editorWrap"></div>
      </section>

      <aside class="panel toc">
        <div class="panelHead">
          <div class="h">ç›®éŒ„ <span class="pill gray">å¯é»å›ç·¨è¼¯å€</span></div>
          <span class="pill gray" title="å¸¸ç”¨ï¼š/h2 /h3 /quote /callout /todo">/ æŒ‡ä»¤</span>
        </div>
        <div class="tocList" id="tocList"></div>
      </aside>
    </main>
  </div>

  <!-- =========================
       PUBLIC PAGE (route: #/p/<key>)
       ========================= -->
  <div id="appPublic">
    <div class="publicTop">
      <div class="left">
        <button class="btn" id="btnBackToEdit">â† å›ç·¨è¼¯</button>
        <span class="pill gray" id="publicBadge">å…¬é–‹é </span>
      </div>
      <div class="right">
        <button class="btn" id="btnCopyPublicTop">è¤‡è£½é€£çµ</button>
        <button class="btn primary" id="btnOpenNewTab">é–‹æ–°åˆ†é </button>
      </div>
    </div>

    <div class="publicWrap">
      <div class="publicCard">
        <div class="publicCover" id="publicCover" style="display:none;"></div>
        <div class="publicBody">
          <h1 class="publicTitle" id="publicTitle"></h1>
          <div class="publicMeta" id="publicMeta"></div>
          <p class="publicDesc" id="publicDesc" style="display:none;"></p>

          <!-- ToastUI Viewer container -->
          <div id="publicViewer"></div>

          <div id="publicNotice" style="display:none;margin-top:14px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–‡ç« è¨­å®š Drawer -->
  <div class="mask" id="drawerMask">
    <div class="drawer" role="dialog" aria-modal="true">
      <h3>æ–‡ç« è¨­å®šï¼ˆå«å°é¢ï¼‰</h3>

      <div class="field">
        <label>Slugï¼ˆç¶²å€å°¾å·´ï¼Œä¾‹å¦‚ï¼šmy-first-postï¼‰</label>
        <input id="settingSlug" placeholder="my-first-post" />
      </div>

      <div class="field">
        <label>æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
        <input id="settingTags" placeholder="æ—¥èª, N3, å£èªª" />
      </div>

      <div class="field">
        <label>æ‘˜è¦ï¼ˆç”¨æ–¼åˆ—è¡¨ã€SEOã€åˆ†äº«åœ–ï¼‰</label>
        <textarea id="settingDesc" placeholder="é€™ç¯‡æ–‡ç« é‡é»æ˜¯ä»€éº¼ï¼Ÿç”¨ 1ï½2 å¥è©±æè¿°"></textarea>
      </div>

      <div class="field">
        <label>å°é¢åœ–ï¼ˆå¯æ‹–æ›³ / ä¸Šå‚³ / è²¼ä¸Šï¼‰</label>
        <div class="coverBox" id="coverBox" tabindex="0">
          <div class="coverPreview" id="coverPreview" style="display:none;"></div>
          <div class="coverHint" id="coverHint">
            âœ… ç›´æ¥æŠŠåœ–ç‰‡æ‹–é€²ä¾†ï¼Œæˆ–é»é€™è£¡é¸æª”æ¡ˆï¼Œæˆ– Ctrl+V è²¼ä¸Šåœ–ç‰‡ã€‚<br>
            âœ… ç³»çµ±æœƒè‡ªå‹•å£“ç¸®ï¼ˆå»ºè­°å°é¢ä¸ç”¨è¶…å¤§ï¼Œæœƒæ›´çœç©ºé–“ï¼‰ã€‚
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" id="btnPickCover" type="button">é¸æ“‡åœ–ç‰‡</button>
            <button class="btn danger" id="btnRemoveCover" type="button">ç§»é™¤å°é¢</button>
          </div>
          <input type="file" id="coverInput" accept="image/*" style="display:none;">
        </div>
      </div>

      <div class="drawerActions">
        <button class="btn" id="btnCloseDrawer">é—œé–‰</button>
        <button class="btn primary" id="btnSaveSettings">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- Overlay: é–±è®€æ¨¡å¼ -->
  <div class="overlayMask" id="readerMask">
    <div class="overlayPanel">
      <div class="overlayHead">
        <div class="h">é–±è®€æ¨¡å¼ <span class="pill gray" id="readerStatus">å·²æ›´æ–°</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnCloseReader">é—œé–‰</button>
          <button class="btn primary" id="btnRefreshReader">æ›´æ–°</button>
        </div>
      </div>
      <div class="overlayBody">
        <div class="readerCover" id="readerCover" style="display:none;"></div>
        <h1 class="readerTitle" id="readerTitle"></h1>
        <div class="readerMeta" id="readerMeta"></div>
        <div class="readerContent" id="readerContent"></div>
      </div>
    </div>
  </div>

  <!-- Overlay: åˆ†äº«åœ– -->
  <div class="overlayMask" id="shareMask">
    <div class="overlayPanel">
      <div class="overlayHead">
        <div class="h">ç¤¾ç¾¤åˆ†äº«åœ–ç”¢ç”Ÿå™¨ <span class="pill gray">ä¸€éµè¼¸å‡º</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnCloseShare">é—œé–‰</button>
          <button class="btn primary" id="btnBuildShare">é‡æ–°ç”¢ç”Ÿ</button>
        </div>
      </div>

      <div class="overlayBody">
        <div class="shareGrid">
          <div>
            <div class="sharePreview">
              <img id="shareImg" alt="share preview" style="display:none;">
              <div id="shareEmpty" style="color:#94a3b8;font-weight:1000;padding:18px;text-align:center;">
                é»ã€Œé‡æ–°ç”¢ç”Ÿã€å°±æœƒå‡ºç¾é è¦½åœ– âœ¨
              </div>
            </div>

            <div class="shareBtns">
              <button class="btn" data-size="1200x630" id="btnDl1">ä¸‹è¼‰ 1200Ã—630</button>
              <button class="btn" data-size="1080x1080" id="btnDl2">ä¸‹è¼‰ 1080Ã—1080</button>
              <button class="btn" data-size="1080x1350" id="btnDl3">ä¸‹è¼‰ 1080Ã—1350</button>
            </div>

            <div class="smallHint" style="margin-top:8px;">
              âœ… æœƒè‡ªå‹•å¸¶å…¥ï¼šå°é¢ï¼ˆè‹¥æœ‰ï¼‰ã€æ¨™é¡Œã€æ‘˜è¦ã€æ¨™ç±¤ã€å“ç‰Œæ–‡å­—ã€‚<br>
              âœ… ä¸‹è¼‰ç‚º PNGï¼›è‹¥å°é¢å¤ªå¤§ä¹Ÿæ²’é—œä¿‚ï¼Œæœƒè‡ªå‹•è£åˆ‡ç½®ä¸­ã€‚
            </div>
          </div>

          <div>
            <div class="field">
              <label>ç‰ˆå‹é¢¨æ ¼</label>
              <select id="shareTheme">
                <option value="light">æ¸…çˆ½ç™½åº•</option>
                <option value="dark">æ²‰ç©©æš—åº•</option>
              </select>
            </div>

            <div class="field">
              <label>å“ç‰Œæ–‡å­—ï¼ˆå›ºå®šæ”¾å³ä¸‹ï¼‰</label>
              <input id="shareBrand" value="å°ç‹¸æ—¥èª" />
            </div>

            <div class="field">
              <label>ä¸»è‰²ï¼ˆå¯ä¸æ”¹ï¼‰</label>
              <input id="shareColor" value="#2563eb" />
            </div>

            <div class="field">
              <label>æ˜¯å¦ä½¿ç”¨å°é¢ä½œç‚ºèƒŒæ™¯</label>
              <select id="shareUseCover">
                <option value="yes">æ˜¯ï¼ˆæ›´åƒéƒ¨è½æ ¼åˆ†äº«ï¼‰</option>
                <option value="no">å¦ï¼ˆä¹¾æ·¨è‰²å¡Šï¼‰</option>
              </select>
            </div>

            <div class="field">
              <label>å­—é«”ï¼ˆåˆ†äº«åœ–ç”¨ï¼‰</label>
              <select id="shareFont">
                <option value="Noto Sans TC">Noto Sans TC</option>
                <option value="Noto Serif TC">Noto Serif TC</option>
                <option value="Zen Maru Gothic">Zen Maru Gothic</option>
                <option value="Inter">Inter</option>
              </select>
            </div>

            <div class="smallHint">
              å°æŠ€å·§ï¼šåˆ†äº«åœ–çš„å­—ä¸è¦å¤ªå¤šï¼Œæ‘˜è¦æŠ“ 1ï½2 å¥æœ€å¥½çœ‹ã€‚
            </div>
          </div>
        </div>

        <canvas id="shareCanvas" style="display:none;"></canvas>
      </div>
    </div>
  </div>

  <!-- Overlay: ç‰ˆæœ¬ -->
  <div class="overlayMask" id="verMask">
    <div class="overlayPanel">
      <div class="overlayHead">
        <div class="h">ç‰ˆæœ¬ç´€éŒ„ <span class="pill gray">å¯å¾©åŸ</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnCloseVer">é—œé–‰</button>
          <button class="btn" id="btnSaveVer">æ‰‹å‹•å»ºç«‹ç‰ˆæœ¬</button>
          <button class="btn primary" id="btnRollback10">å¾©åŸåˆ° 10 åˆ†é˜å‰</button>
        </div>
      </div>
      <div class="overlayBody">
        <div class="smallHint" style="margin-bottom:10px;">
          âœ… ç³»çµ±æœƒè‡ªå‹•æ¯ 10 åˆ†é˜ï¼ˆæœ‰è®Šæ›´æ‰æœƒï¼‰å­˜ä¸€å€‹ç‰ˆæœ¬ï¼›æœ€å¤šä¿ç•™ 30 ä»½ã€‚<br>
          âœ… ä½ ä¹Ÿå¯ä»¥æŒ‰ã€Œæ‰‹å‹•å»ºç«‹ç‰ˆæœ¬ã€åšä¸€å€‹ checkpointã€‚
        </div>
        <div class="verList" id="verList"></div>
      </div>
    </div>
  </div>

  <!-- Overlay: æŒ‡ä»¤ -->
  <div class="overlayMask" id="cmdMask">
    <div class="overlayPanel">
      <div class="overlayHead">
        <div class="h">Slash æŒ‡ä»¤æ¸…å–® <span class="pill gray">åœ¨è¡Œé¦–è¼¸å…¥ + ç©ºç™½/Enter</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnCloseCmd">é—œé–‰</button>
          <button class="btn primary" id="btnInsertHelp">æŠŠ /help æ’åˆ°æ¸¸æ¨™è™•</button>
        </div>
      </div>
      <div class="overlayBody" style="line-height:1.8;">
        <div style="font-weight:1100;margin-bottom:10px;">å¯ç”¨æŒ‡ä»¤ï¼ˆè¡Œé¦–è¼¸å…¥ä¾‹å¦‚ï¼š<code>/h2</code> ç„¶å¾ŒæŒ‰ç©ºç™½ï¼‰</div>
        <ul style="margin:0;padding-left:18px;font-weight:900;color:var(--text);">
          <li><code>/h1</code> ~ <code>/h6</code>ï¼šæ¨™é¡Œå±¤ç´š</li>
          <li><code>/quote</code>ï¼šå¼•ç”¨ï¼ˆ<code>&gt; </code>ï¼‰</li>
          <li><code>/callout</code>ï¼šæ’å…¥æç¤ºæ¡†ï¼ˆé è¨­ noteï¼‰</li>
          <li><code>/tip</code>ï¼šæ’å…¥ TIP æç¤ºæ¡†</li>
          <li><code>/warn</code>ï¼šæ’å…¥ WARN è­¦å‘Šæ¡†</li>
          <li><code>/note</code>ï¼šæ’å…¥ NOTE ç­†è¨˜æ¡†</li>
          <li><code>/hr</code>ï¼šåˆ†éš”ç·šï¼ˆ<code>---</code>ï¼‰</li>
          <li><code>/todo</code>ï¼šå¾…è¾¦ï¼ˆ<code>- [ ] </code>ï¼‰</li>
          <li><code>/help</code>ï¼šæ’å…¥å°æŠ„ï¼ˆå‘½ä»¤æ¸…å–®ï¼‰</li>
        </ul>
        <div class="smallHint" style="margin-top:12px;">
          å°æé†’ï¼šæŒ‡ä»¤æœƒç›¡é‡åŒæ™‚æ”¯æ´ Markdown / WYSIWYGï¼ˆè‹¥ä½ åœ¨ WYSIWYGï¼Œç³»çµ±æœƒè‡ªå‹•å¹«ä½ è½‰åˆ° Markdown åšè½‰æ›ï¼Œå†åˆ‡å›å»ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- Import file input -->
  <input type="file" id="jsonInput" accept="application/json" style="display:none;" />

  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <script>
    // =============================
    // Storage model
    // =============================
    const LS_KEY = "vocus_like_editor_pro_public_v1";

    const state = loadState();
    let editor = null;
    let autosaveTimer = null;
    let tocTimer = null;
    let currentFilter = "all"; // all|draft|published
    let isBooting = true;

    // public viewer instance
    let publicViewer = null;

    boot();

    function boot(){
      ensureAtLeastOnePost();
      applyUiVars();
      mountEditor(state.ui.theme);
      bindUI();
      renderPostList();
      loadPostToEditor(state.currentId);
      updateToc();
      refreshSaveState("å·²å„²å­˜");
      isBooting = false;

      // router
      window.addEventListener("hashchange", handleRoute);
      handleRoute(); // initial
    }

    // =============================
    // ROUTER
    //   #/edit (default) -> editor
    //   #/p/<key> -> public page
    // key = slug if set, else id
    // =============================
    function handleRoute(){
      const h = location.hash || "";
      if(h.startsWith("#/p/")){
        const key = decodeURIComponent(h.slice(4));
        showPublicRoute(key);
      }else{
        showEditorRoute();
      }
    }

    function showEditorRoute(){
      document.getElementById("appPublic").style.display = "none";
      document.getElementById("appEditor").style.display = "block";
    }

    function showPublicRoute(key){
      document.getElementById("appEditor").style.display = "none";
      document.getElementById("appPublic").style.display = "block";

      const found = findPostByPublicKey(key);
      if(!found){
        renderPublicNotFound("æ‰¾ä¸åˆ°é€™ç¯‡æ–‡ç« ï¼ˆå¯èƒ½å·²è¢«åˆªé™¤æˆ–é€£çµéŒ¯èª¤ï¼‰ã€‚");
        return;
      }
      const { id, post } = found;

      // only published can be viewed
      if((post.status || "draft") !== "published"){
        renderPublicNotFound("é€™ç¯‡æ–‡ç« ç›®å‰é‚„æ˜¯è‰ç¨¿ï¼Œå°šæœªå…¬é–‹ã€‚");
        return;
      }

      // Render
      renderPublicPost(id, post);
    }

    function renderPublicNotFound(msg){
      document.getElementById("publicTitle").textContent = "ç„¡æ³•é¡¯ç¤º";
      document.getElementById("publicMeta").textContent = "";
      document.getElementById("publicDesc").style.display = "none";
      document.getElementById("publicCover").style.display = "none";
      document.getElementById("publicViewer").innerHTML = "";

      const n = document.getElementById("publicNotice");
      n.style.display = "block";
      n.className = "publicNotice";
      n.textContent = msg;
    }

    function renderPublicPost(id, post){
      // cover
      const cover = document.getElementById("publicCover");
      if(post.coverDataUrl){
        cover.style.display = "block";
        cover.innerHTML = `<img src="${post.coverDataUrl}" alt="cover">`;
      }else{
        cover.style.display = "none";
        cover.innerHTML = "";
      }

      // title
      document.getElementById("publicTitle").textContent = post.title || "ï¼ˆæœªå‘½åï¼‰";

      // desc
      const desc = (post.settings?.desc || "").trim();
      const descEl = document.getElementById("publicDesc");
      if(desc){
        descEl.style.display = "block";
        descEl.textContent = desc;
      }else{
        descEl.style.display = "none";
        descEl.textContent = "";
      }

      // meta
      const tags = (post.settings?.tags || "").trim();
      const slug = (post.settings?.slug || "").trim();
      const updated = new Date(post.updatedAt || Date.now()).toLocaleString();
      const metaParts = [
        `ç‹€æ…‹ï¼šå·²ç™¼ä½ˆ`,
        slug ? `Slugï¼š${slug}` : `IDï¼š${id}`,
        tags ? `Tagsï¼š${tags}` : "",
        `æ›´æ–°ï¼š${updated}`
      ].filter(Boolean);
      document.getElementById("publicMeta").textContent = metaParts.join(" ï½œ ");

      // notice off
      const n = document.getElementById("publicNotice");
      n.style.display = "none";
      n.textContent = "";

      // viewer
      const viewerEl = document.getElementById("publicViewer");
      viewerEl.innerHTML = "";

      // ToastUI Viewer factory
      try{
        publicViewer = toastui.Editor.factory({
          el: viewerEl,
          viewer: true,
          initialValue: post.markdown || ""
        });
      }catch(e){
        // fallback: use current editor to render HTML if viewer fails
        if(editor){
          const curMd = editor.getMarkdown();
          editor.setMarkdown(post.markdown || "", false);
          viewerEl.innerHTML = editor.getHTML();
          editor.setMarkdown(curMd, false);
          editor.changeMode(state.ui.mode, true);
        }else{
          viewerEl.textContent = post.markdown || "";
        }
      }

      // badge + buttons copy/open
      const key = getPublicKey(id, post);
      document.getElementById("publicBadge").textContent = `å…¬é–‹é ï¼š${key}`;
      const url = getPublicUrl(key);
      document.getElementById("btnOpenNewTab").onclick = () => window.open(url, "_blank");
      document.getElementById("btnCopyPublicTop").onclick = () => copyText(url, "å·²è¤‡è£½å…¬é–‹é€£çµ");
    }

    function getPublicKey(id, post){
      const slug = (post.settings?.slug || "").trim();
      return slug || id;
    }

    function findPostByPublicKey(key){
      const posts = state.posts || {};
      for(const [id, p] of Object.entries(posts)){
        const slug = (p.settings?.slug || "").trim();
        if(slug && slug === key) return { id, post:p };
        if(id === key) return { id, post:p };
      }
      return null;
    }

    function getPublicUrl(key){
      const base = location.href.split("#")[0];
      return base + "#/p/" + encodeURIComponent(key);
    }

    function goPublicOfCurrent(){
      const p = state.posts[state.currentId];
      if(!p) return;
      if((p.status || "draft") !== "published"){
        alert("é€™ç¯‡æ–‡ç« é‚„æ˜¯è‰ç¨¿ã€‚å…ˆåˆ‡æ›æˆã€Œå·²ç™¼ä½ˆã€æ‰æœƒå…¬é–‹å–”ï¼");
        return;
      }
      const key = getPublicKey(state.currentId, p);
      location.hash = "#/p/" + encodeURIComponent(key);
    }

    function copyPublicOfCurrent(){
      const p = state.posts[state.currentId];
      if(!p) return;
      const key = getPublicKey(state.currentId, p);
      const url = getPublicUrl(key);
      copyText(url, "å·²è¤‡è£½å…¬é–‹é€£çµ");
    }

    async function copyText(text, toastMsg){
      try{
        await navigator.clipboard.writeText(text);
        refreshSaveState(toastMsg || "å·²è¤‡è£½");
        setTimeout(()=>refreshSaveState("å·²å„²å­˜"), 900);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        refreshSaveState(toastMsg || "å·²è¤‡è£½");
        setTimeout(()=>refreshSaveState("å·²å„²å­˜"), 900);
      }
    }

    // =============================
    // State load/save
    // =============================
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);

        s.posts = s.posts || {};
        s.ui = s.ui || {};
        s.ui.theme = s.ui.theme || "light";
        s.ui.fontFamily = s.ui.fontFamily || '"Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif';
        s.ui.fontSize = Number(s.ui.fontSize || 16);
        s.ui.mode = s.ui.mode || "markdown";
        s.currentId = s.currentId || "";
        return s;
      }catch{
        return defaultState();
      }
    }

    function defaultState(){
      return {
        version: 1,
        currentId: "",
        posts: {},
        ui: {
          theme: "light",
          fontFamily: '"Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif',
          fontSize: 16,
          mode: "markdown"
        }
      };
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function newId(){
      return "p_" + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    }

    function ensureAtLeastOnePost(){
      const ids = Object.keys(state.posts);
      if(ids.length === 0){
        const id = newId();
        state.posts[id] = {
          title: "ç¯„ä¾‹æ–‡ç« ï¼šé–‹å§‹å¯«å§",
          status: "draft", // draft|published
          markdown:
`# é€™æ˜¯ä¸€ç¯‡ç¯„ä¾‹

æŠŠæ–‡ç« åˆ‡åˆ°ã€Œå·²ç™¼ä½ˆã€å¾Œï¼Œä½ å°±å¯ä»¥ç”¨å…¬é–‹é é€£çµï¼š

- é»ä¸Šæ–¹ã€Œå…¬é–‹é ã€æˆ–ã€Œè¤‡è£½é€£çµã€
- é€£çµæ ¼å¼ï¼š#/p/slug æˆ– #/p/id

## è©¦è©¦çœ‹
å…ˆåˆ°ã€Œæ–‡ç« è¨­å®šã€å¡« slugï¼Œå†æŠŠç‹€æ…‹åˆ‡æˆå·²ç™¼ä½ˆã€‚

<div class="callout note">
  <div class="calloutTitle">ğŸ“ NOTE</div>
  é€™æ˜¯ä¸€å€‹ callout ç¯„ä¾‹ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ /callout å¿«é€Ÿæ’å…¥ã€‚
</div>
`,
          settings: { slug:"", tags:"", desc:"" },
          coverDataUrl: "",
          updatedAt: Date.now(),
          versions: [],
          lastAutoVerAt: 0,
          lastAutoHash: ""
        };
        state.currentId = id;
        saveState();
      }else if(!state.currentId || !state.posts[state.currentId]){
        state.currentId = ids.sort((a,b)=>(state.posts[b].updatedAt||0)-(state.posts[a].updatedAt||0))[0];
        saveState();
      }
    }

    // =============================
    // UI vars
    // =============================
    function applyUiVars(){
      document.documentElement.style.setProperty("--content-font-family", state.ui.fontFamily);
      document.documentElement.style.setProperty("--content-font-size", state.ui.fontSize + "px");
      document.getElementById("fontSelect").value = state.ui.fontFamily;
      document.getElementById("fontSizeLabel").textContent = String(state.ui.fontSize);

      if(state.ui.theme === "dark") document.body.classList.add("app-dark");
      else document.body.classList.remove("app-dark");

      document.getElementById("btnTheme").textContent = (state.ui.theme === "dark") ? "â˜€ï¸ æ·ºè‰²" : "ğŸŒ™ æ·±è‰²";
    }

    // =============================
    // Editor mount
    // =============================
    function mountEditor(theme){
      const wrap = document.getElementById("editorWrap");
      wrap.innerHTML = "";

      const post = state.posts[state.currentId];
      const initialValue = post ? post.markdown : "";

      editor = new toastui.Editor({
        el: wrap,
        height: "100%",
        previewStyle: "vertical",
        initialEditType: state.ui.mode,
        initialValue,
        theme: (theme === "dark") ? "dark" : "light",
        usageStatistics: false,
        hideModeSwitch: true,
        placeholder: "é–‹å§‹è¼¸å…¥â€¦ï¼ˆMarkdown / WYSIWYG å¯åˆ‡æ›ï¼‰",
        toolbarItems: [
          ["heading","bold","italic","strike"],
          ["hr","quote"],
          ["ul","ol","task"],
          ["table","link","image"],
          ["code","codeblock"]
        ]
      });

      editor.on("change", onEditorChange);
      editor.on("keyup", debounce(updateToc, 200));
      editor.on("focus", () => refreshSaveState("ç·¨è¼¯ä¸­"));

      attachEditorKeydownListener();
      setModeButtonText();
    }

    function attachEditorKeydownListener(){
      try{
        const els = editor.getEditorElements ? editor.getEditorElements() : null;
        const nodes = [];
        if(els){
          Object.values(els).forEach(el => {
            if(el && el.querySelectorAll){
              el.querySelectorAll(".ProseMirror").forEach(pm => nodes.push(pm));
            }
          });
        }else{
          document.querySelectorAll(".ProseMirror").forEach(pm => nodes.push(pm));
        }
        nodes.forEach(pm => pm.addEventListener("keydown", onEditorKeydown, true));
      }catch(e){}
    }

    // =============================
    // Slash commands
    // =============================
    function onEditorKeydown(ev){
      if(!editor) return;
      const trigger = (ev.key === " " || ev.key === "Enter");
      if(!trigger) return;

      let mdSelStart = null;
      let mdSelEnd = null;

      try{
        const sel = editor.getSelection();
        if(editor.isMarkdownMode()){
          mdSelStart = sel[0];
          mdSelEnd = sel[1];
        }else{
          const conv = editor.convertPosToMatchEditorMode(sel[0], sel[1], "markdown");
          mdSelStart = conv[0];
          mdSelEnd = conv[1];
        }
      }catch(e){
        return;
      }

      if(!mdSelStart || !Array.isArray(mdSelStart)) return;

      const line = mdSelStart[0];
      const ch = mdSelStart[1];

      const md = editor.getMarkdown();
      const lines = md.split("\n");
      const current = (lines[line] ?? "");
      const prefix = current.slice(0, ch);

      const m = prefix.match(/^(\s*)\/([a-zA-Z0-9\-]+)$/);
      if(!m) return;

      const indent = m[1] || "";
      const cmd = (m[2] || "").toLowerCase();

      const expansions = getCommandExpansion(cmd);
      if(!expansions) return;

      ev.preventDefault();

      const wasWw = !editor.isMarkdownMode();
      const prevMode = wasWw ? "wysiwyg" : "markdown";

      if(wasWw){
        try{ editor.changeMode("markdown", true); }catch(e){}
      }

      const startCh = indent.length;
      const endCh = startCh + ("/" + cmd).length;

      try{
        editor.setSelection([line, startCh], [line, endCh]);
        editor.replaceSelection(expansions.insert);
      }catch(e){}

      try{
        const afterMd = editor.getMarkdown().split("\n");
        const newLineText = (afterMd[line] ?? "");
        const newCh = Math.min(newLineText.length, (expansions.cursorCh ?? newLineText.length));
        editor.setSelection([line, newCh], [line, newCh]);
      }catch(e){}

      if(wasWw){
        try{ editor.changeMode(prevMode, true); }catch(e){}
      }

      scheduleAutoSave();
      updateToc();
    }

    function getCommandExpansion(cmd){
      if(/^h[1-6]$/.test(cmd)){
        const level = Number(cmd.slice(1));
        const hashes = "#".repeat(level);
        return { insert: hashes + " ", cursorCh: (hashes.length + 1) };
      }

      switch(cmd){
        case "quote":
          return { insert: "> ", cursorCh: 2 };
        case "hr":
          return { insert: "---\n\n", cursorCh: 4 };
        case "todo":
          return { insert: "- [ ] ", cursorCh: 6 };
        case "callout":
        case "note":
          return { insert: buildCallout("note"), cursorCh: buildCallout("note").split("\n")[0].length };
        case "tip":
          return { insert: buildCallout("tip"), cursorCh: buildCallout("tip").split("\n")[0].length };
        case "warn":
        case "warning":
          return { insert: buildCallout("warn"), cursorCh: buildCallout("warn").split("\n")[0].length };
        case "help":
          return { insert: buildHelpBlock(), cursorCh: 0 };
        default:
          return null;
      }
    }

    function buildCallout(kind){
      const map = {
        tip:  { emoji:"ğŸ’¡", title:"TIP",  cls:"tip"  },
        warn: { emoji:"âš ï¸", title:"WARN", cls:"warn" },
        note: { emoji:"ğŸ“", title:"NOTE", cls:"note" }
      };
      const x = map[kind] || map.note;
      return `<div class="callout ${x.cls}">
  <div class="calloutTitle">${x.emoji} ${x.title}</div>
  å…§å®¹å¯«é€™è£¡â€¦
</div>\n\n`;
    }

    function buildHelpBlock(){
      return `\n\n---\n\n## / æŒ‡ä»¤å°æŠ„\n\n- /h1 ~ /h6ï¼šæ¨™é¡Œå±¤ç´š\n- /quoteï¼šå¼•ç”¨ï¼ˆ> ï¼‰\n- /calloutï¼šæç¤ºæ¡†ï¼ˆNOTEï¼‰\n- /tipï¼šTIP æç¤ºæ¡†\n- /warnï¼šWARN è­¦å‘Šæ¡†\n- /noteï¼šNOTE ç­†è¨˜æ¡†\n- /hrï¼šåˆ†éš”ç·š\n- /todoï¼šå¾…è¾¦\n\n---\n\n`;
    }

    // =============================
    // Autosave + auto versions
    // =============================
    function onEditorChange(){
      if(isBooting) return;
      refreshSaveState("å„²å­˜ä¸­â€¦");
      scheduleAutoSave();
      maybeAutoVersion();
    }

    function scheduleAutoSave(){
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        const id = state.currentId;
        const p = state.posts[id];
        if(!p || !editor) return;

        p.markdown = editor.getMarkdown();
        p.updatedAt = Date.now();

        const t = document.getElementById("titleInput").value.trim();
        if(t) p.title = t;

        saveState();
        renderPostList(false);
        refreshSaveState("å·²å„²å­˜");
      }, 350);
    }

    function fnv1a(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193) >>> 0;
      }
      return ("0000000" + h.toString(16)).slice(-8);
    }

    function snapshotHash(p){
      return fnv1a([
        p.title || "",
        p.status || "",
        p.markdown || "",
        JSON.stringify(p.settings || {}),
        (p.coverDataUrl || "").slice(0, 2000),
        (p.coverDataUrl || "").slice(-2000)
      ].join("||"));
    }

    function maybeAutoVersion(){
      const p = state.posts[state.currentId];
      if(!p || !editor) return;

      const now = Date.now();
      const interval = 10 * 60 * 1000;

      const h = snapshotHash({
        ...p,
        markdown: editor.getMarkdown()
      });

      if(p.lastAutoHash && p.lastAutoHash === h) return;
      if(p.lastAutoVerAt && (now - p.lastAutoVerAt) < interval) return;

      pushVersion(p, { note:"auto" }, h);
      p.lastAutoVerAt = now;
      p.lastAutoHash = h;
      saveState();
    }

    function pushVersion(p, extra={}, forcedHash=null){
      const h = forcedHash || snapshotHash(p);
      const v = {
        ts: Date.now(),
        title: p.title || "",
        status: p.status || "draft",
        markdown: editor ? editor.getMarkdown() : (p.markdown || ""),
        settings: JSON.parse(JSON.stringify(p.settings || {})),
        coverDataUrl: p.coverDataUrl || "",
        hash: h,
        note: extra.note || ""
      };
      p.versions = p.versions || [];
      p.versions.unshift(v);
      p.versions = p.versions.slice(0, 30);
    }

    // =============================
    // Post list + filtering
    // =============================
    function renderPostList(keepScroll=true){
      const list = document.getElementById("postList");
      const prevScroll = list.scrollTop;

      const items = Object.entries(state.posts)
        .sort((a,b)=> (b[1].updatedAt||0) - (a[1].updatedAt||0))
        .filter(([id,p]) => {
          if(currentFilter === "all") return true;
          if(currentFilter === "draft") return (p.status || "draft") === "draft";
          if(currentFilter === "published") return (p.status || "draft") === "published";
          return true;
        });

      list.innerHTML = "";

      items.forEach(([id, p]) => {
        const li = document.createElement("li");
        li.className = "postItem" + (id === state.currentId ? " active" : "");

        const badge = (p.status === "published")
          ? `<span class="badge pub">å·²ç™¼ä½ˆ</span>`
          : `<span class="badge draft">è‰ç¨¿</span>`;

        li.innerHTML = `
          <div class="row">
            <div class="t">${escapeHtml(p.title || "ï¼ˆæœªå‘½åï¼‰")}</div>
            ${badge}
          </div>
          <div class="meta">${new Date(p.updatedAt||Date.now()).toLocaleString()}</div>
        `;
        li.addEventListener("click", () => {
          if(id === state.currentId) return;
          switchPost(id);
        });
        list.appendChild(li);
      });

      const total = Object.keys(state.posts).length;
      document.getElementById("postCount").textContent = total + " ç¯‡";

      if(keepScroll) list.scrollTop = prevScroll;
    }

    function switchPost(id){
      const cur = state.posts[state.currentId];
      if(cur && editor){
        cur.markdown = editor.getMarkdown();
        cur.updatedAt = Date.now();
      }

      state.currentId = id;
      saveState();

      loadPostToEditor(id);
      renderPostList();
      updateToc();
      refreshSaveState("å·²å„²å­˜");
    }

    function loadPostToEditor(id){
      const p = state.posts[id];
      if(!p || !editor) return;

      document.getElementById("titleInput").value = p.title || "";
      editor.setMarkdown(p.markdown || "", false);
      editor.changeMode(state.ui.mode, true);

      document.getElementById("settingSlug").value = (p.settings?.slug || "");
      document.getElementById("settingTags").value = (p.settings?.tags || "");
      document.getElementById("settingDesc").value = (p.settings?.desc || "");

      syncStatusButton();
      syncCoverPreview();
      setModeButtonText();
    }

    function syncStatusButton(){
      const p = state.posts[state.currentId];
      const t = document.getElementById("statusText");
      if(!p) return;
      if(p.status === "published"){
        t.textContent = "å·²ç™¼ä½ˆ";
        document.getElementById("btnToggleStatus").classList.add("soft");
      }else{
        t.textContent = "è‰ç¨¿";
        document.getElementById("btnToggleStatus").classList.remove("soft");
      }
    }

    // =============================
    // TOC
    // =============================
    function updateToc(){
      clearTimeout(tocTimer);
      tocTimer = setTimeout(() => {
        const toc = buildToc(editor ? editor.getMarkdown() : "");
        renderToc(toc);
      }, 120);
    }

    function buildToc(md){
      const lines = md.split("\n");
      const toc = [];
      let inCode = false;
      for(let i=0;i<lines.length;i++){
        const line = lines[i];
        if(line.trim().startsWith("```")){ inCode = !inCode; continue; }
        if(inCode) continue;

        const m = line.match(/^(#{1,6})\s+(.+?)\s*$/);
        if(!m) continue;
        const level = m[1].length;
        const text = m[2].replace(/\s+#*\s*$/, "").trim();
        if(!text) continue;
        toc.push({ level, text, line: i });
      }
      return toc;
    }

    function renderToc(toc){
      const wrap = document.getElementById("tocList");
      wrap.innerHTML = "";

      if(!toc.length){
        wrap.innerHTML = `<div style="padding:10px;color:var(--muted);font-weight:1000;">ï¼ˆæ²’æœ‰æ¨™é¡Œã€‚å…ˆç”¨ # / ## å¯«å¹¾å€‹å§ï¼‰</div>`;
        return;
      }

      toc.forEach(h => {
        const item = document.createElement("div");
        item.className = "tocItem";
        item.dataset.line = String(h.line);

        const indent = Math.max(0, h.level - 1) * 14;
        item.innerHTML = `
          <span class="tocLevel">H${h.level}</span>
          <span style="width:${indent}px;flex:0 0 auto;"></span>
          <span class="tocText">${escapeHtml(h.text)}</span>
        `;
        item.addEventListener("click", () => jumpToHeadingLine(h.line));
        wrap.appendChild(item);
      });
    }

    function jumpToHeadingLine(line){
      if(!editor) return;

      const mdStart = [line, 0];
      const mdEnd = [line, 0];

      try{
        if(editor.isMarkdownMode()){
          editor.setSelection(mdStart, mdEnd);
        }else{
          const wwPos = editor.convertPosToMatchEditorMode(mdStart, mdEnd, "wysiwyg");
          editor.setSelection(wwPos[0], wwPos[1]);
        }
        editor.focus();
      }catch(e){
        try{
          editor.changeMode("markdown", true);
          editor.setSelection(mdStart, mdEnd);
          editor.focus();
        }catch(_){}
      }
    }

    // =============================
    // Cover upload / drag / paste (auto compress)
    // =============================
    function syncCoverPreview(){
      const p = state.posts[state.currentId];
      const prev = document.getElementById("coverPreview");
      if(!p) return;

      if(p.coverDataUrl){
        prev.style.display = "block";
        prev.innerHTML = `<img src="${p.coverDataUrl}" alt="cover">`;
      }else{
        prev.style.display = "none";
        prev.innerHTML = "";
      }
    }

    async function loadImageFromFile(file){
      const dataUrl = await fileToDataUrl(file);
      const compressed = await compressDataUrl(dataUrl, 1400, 0.88);
      return compressed;
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function loadImg(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    async function compressDataUrl(dataUrl, maxSize=1400, quality=0.88){
      const img = await loadImg(dataUrl);
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxSize / Math.max(w,h));
      const nw = Math.max(1, Math.round(w * scale));
      const nh = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = nw;
      canvas.height = nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, nw, nh);

      return canvas.toDataURL("image/jpeg", quality);
    }

    async function setCoverDataUrl(dataUrl){
      const p = state.posts[state.currentId];
      if(!p) return;
      p.coverDataUrl = dataUrl || "";
      p.updatedAt = Date.now();
      saveState();
      syncCoverPreview();
      refreshSaveState("å·²å„²å­˜");
    }

    // =============================
    // Reader
    // =============================
    function refreshReaderContent(){
      const p = state.posts[state.currentId];
      if(!p || !editor) return;

      const title = p.title || "ï¼ˆæœªå‘½åï¼‰";
      const html = editor.getHTML();

      const tags = (p.settings?.tags || "").trim();
      const slug = (p.settings?.slug || "").trim();
      const desc = (p.settings?.desc || "").trim();
      const status = p.status === "published" ? "å·²ç™¼ä½ˆ" : "è‰ç¨¿";

      const meta = [
        `ç‹€æ…‹ï¼š${status}`,
        slug ? `Slugï¼š${slug}` : "",
        tags ? `Tagsï¼š${tags}` : "",
        desc ? `æ‘˜è¦ï¼š${desc}` : ""
      ].filter(Boolean).join(" ï½œ ") || "ï¼ˆå°šæœªå¡«å¯«æ–‡ç« è¨­å®šï¼‰";

      document.getElementById("readerTitle").textContent = title;
      document.getElementById("readerMeta").textContent = meta;
      document.getElementById("readerContent").innerHTML = html;

      const coverWrap = document.getElementById("readerCover");
      if(p.coverDataUrl){
        coverWrap.style.display = "block";
        coverWrap.innerHTML = `<img src="${p.coverDataUrl}" alt="cover">`;
      }else{
        coverWrap.style.display = "none";
        coverWrap.innerHTML = "";
      }

      document.getElementById("readerStatus").textContent = "å·²æ›´æ–°";
    }

    // =============================
    // Share images generator (unchanged)
    // =============================
    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines){
      const words = String(text || "").split(/\s+/).filter(Boolean);
      let line = "";
      let lines = [];
      for(let i=0;i<words.length;i++){
        const test = line ? (line + " " + words[i]) : words[i];
        const w = ctx.measureText(test).width;
        if(w > maxWidth && line){
          lines.push(line);
          line = words[i];
          if(maxLines && lines.length >= maxLines) break;
        }else{
          line = test;
        }
      }
      if(line && (!maxLines || lines.length < maxLines)) lines.push(line);
      lines = maxLines ? lines.slice(0, maxLines) : lines;

      lines.forEach((ln, idx) => ctx.fillText(ln, x, y + idx*lineHeight));
      return lines.length;
    }

    async function buildShare(size){
      const p = state.posts[state.currentId];
      if(!p || !editor) return null;

      const [W,H] = size.split("x").map(n => parseInt(n,10));
      const canvas = document.getElementById("shareCanvas");
      canvas.width = W;
      canvas.height = H;
      const ctx = canvas.getContext("2d");

      const theme = document.getElementById("shareTheme").value;
      const brand = document.getElementById("shareBrand").value.trim() || "å°ç‹¸æ—¥èª";
      const color = document.getElementById("shareColor").value.trim() || "#2563eb";
      const useCover = document.getElementById("shareUseCover").value === "yes";
      const font = document.getElementById("shareFont").value || "Noto Sans TC";

      const title = (p.title || "ï¼ˆæœªå‘½åï¼‰").trim();
      const desc = (p.settings?.desc || "").trim();
      const tags = (p.settings?.tags || "").trim();

      if(theme === "dark"){
        ctx.fillStyle = "#0b1220";
        ctx.fillRect(0,0,W,H);
      }else{
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,W,H);
      }

      if(useCover && p.coverDataUrl){
        try{
          const img = await loadImg(p.coverDataUrl);
          const coverH = Math.round(H * 0.55);
          const target = { x:0, y:0, w:W, h:coverH };

          const iw = img.naturalWidth || img.width;
          const ih = img.naturalHeight || img.height;

          const scale = Math.max(target.w/iw, target.h/ih);
          const sw = target.w / scale;
          const sh = target.h / scale;
          const sx = (iw - sw)/2;
          const sy = (ih - sh)/2;

          ctx.drawImage(img, sx, sy, sw, sh, target.x, target.y, target.w, target.h);

          const g = ctx.createLinearGradient(0, 0, 0, coverH);
          if(theme === "dark"){
            g.addColorStop(0, "rgba(11,18,32,.05)");
            g.addColorStop(1, "rgba(11,18,32,.85)");
          }else{
            g.addColorStop(0, "rgba(255,255,255,.05)");
            g.addColorStop(1, "rgba(255,255,255,.92)");
          }
          ctx.fillStyle = g;
          ctx.fillRect(0,0,W,coverH);

        }catch(e){}
      }else{
        ctx.fillStyle = hexToRgba(color, theme === "dark" ? 0.20 : 0.12);
        ctx.fillRect(0,0,W,Math.round(H*0.42));
      }

      const pad = Math.round(W * 0.06);
      const cardX = pad;
      const cardY = Math.round(H * 0.38);
      const cardW = W - pad*2;
      const cardH = H - cardY - pad;

      ctx.fillStyle = theme === "dark" ? "rgba(255,255,255,.06)" : "rgba(2,6,23,.03)";
      roundRect(ctx, cardX, cardY, cardW, cardH, 26, true, false);

      ctx.strokeStyle = theme === "dark" ? "rgba(148,163,184,.25)" : "rgba(15,23,42,.10)";
      ctx.lineWidth = 2;
      roundRect(ctx, cardX, cardY, cardW, cardH, 26, false, true);

      ctx.fillStyle = hexToRgba(color, 0.9);
      roundRect(ctx, cardX, cardY, 10, cardH, 20, true, false);

      const textColor = theme === "dark" ? "#e5e7eb" : "#0f172a";
      const mutedColor = theme === "dark" ? "#94a3b8" : "#64748b";

      ctx.fillStyle = textColor;
      ctx.font = `900 ${Math.round(W*0.045)}px "${font}", "Noto Sans TC", sans-serif`;
      const titleY = cardY + Math.round(cardH*0.26);
      wrapText(ctx, title, cardX + 26, titleY, cardW - 52, Math.round(W*0.052), 3);

      ctx.fillStyle = mutedColor;
      ctx.font = `800 ${Math.round(W*0.028)}px "${font}", "Noto Sans TC", sans-serif`;
      const descY = titleY + Math.round(W*0.19);
      if(desc){
        wrapText(ctx, desc, cardX + 26, descY, cardW - 52, Math.round(W*0.038), 3);
      }else{
        ctx.fillText("ï¼ˆå°šæœªå¡«æ‘˜è¦ï¼šå¯åœ¨æ–‡ç« è¨­å®šå¡«å¯«ï¼‰", cardX + 26, descY);
      }

      if(tags){
        ctx.fillStyle = hexToRgba(color, theme === "dark" ? 0.22 : 0.12);
        const tagY = cardY + cardH - Math.round(W*0.11);
        roundRect(ctx, cardX + 20, tagY, cardW - 40, Math.round(W*0.075), 18, true, false);
        ctx.fillStyle = theme === "dark" ? "#cbd5e1" : "#1e293b";
        ctx.font = `900 ${Math.round(W*0.025)}px "${font}", "Noto Sans TC", sans-serif`;
        ctx.fillText("# " + tags.replaceAll(",", " Â· "), cardX + 32, tagY + Math.round(W*0.048));
      }

      ctx.fillStyle = theme === "dark" ? "rgba(226,232,240,.92)" : "rgba(15,23,42,.86)";
      ctx.font = `1000 ${Math.round(W*0.028)}px "${font}", "Noto Sans TC", sans-serif`;
      const brandW = ctx.measureText(brand).width;
      ctx.fillText(brand, W - pad - brandW, H - Math.round(pad*0.55));

      return canvas.toDataURL("image/png");
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    function hexToRgba(hex, a){
      const h = hex.replace("#","").trim();
      const v = h.length === 3
        ? h.split("").map(c=>c+c).join("")
        : h;
      const r = parseInt(v.slice(0,2),16);
      const g = parseInt(v.slice(2,4),16);
      const b = parseInt(v.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }

    // =============================
    // Versions UI (unchanged)
    // =============================
    function renderVersions(){
      const p = state.posts[state.currentId];
      const wrap = document.getElementById("verList");
      wrap.innerHTML = "";

      if(!p) return;

      const vs = (p.versions || []).slice();
      if(vs.length === 0){
        wrap.innerHTML = `<div style="color:var(--muted);font-weight:1000;">ï¼ˆç›®å‰é‚„æ²’æœ‰ç‰ˆæœ¬ã€‚æŒ‰ä¸Šæ–¹ã€Œæ‰‹å‹•å»ºç«‹ç‰ˆæœ¬ã€å…ˆå­˜ä¸€å€‹å§ï¼‰</div>`;
        return;
      }

      vs.forEach((v, idx) => {
        const div = document.createElement("div");
        div.className = "verItem";
        const note = v.note === "auto" ? "è‡ªå‹•" : "æ‰‹å‹•";
        const st = v.status === "published" ? "å·²ç™¼ä½ˆ" : "è‰ç¨¿";
        div.innerHTML = `
          <div class="left">
            <div class="t">${escapeHtml(v.title || "ï¼ˆæœªå‘½åï¼‰")} <span class="pill gray" style="margin-left:8px;">${note}</span></div>
            <div class="m">${new Date(v.ts).toLocaleString()} ï½œ ${st}</div>
          </div>
          <div class="right">
            <button class="btn" data-act="preview" data-idx="${idx}">é è¦½</button>
            <button class="btn primary" data-act="restore" data-idx="${idx}">å¾©åŸ</button>
          </div>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.idx);
          const act = btn.dataset.act;
          if(Number.isNaN(idx)) return;
          if(act === "restore") restoreVersion(idx);
          if(act === "preview") previewVersion(idx);
        });
      });
    }

    function restoreVersion(idx){
      const p = state.posts[state.currentId];
      if(!p) return;
      const v = (p.versions || [])[idx];
      if(!v) return;

      const ok = confirm("ç¢ºå®šå¾©åŸåˆ°é€™å€‹ç‰ˆæœ¬ï¼Ÿç›®å‰å…§å®¹æœƒè¢«è¦†è“‹ï¼ˆä½†ä½ ä»å¯å†å¾ç‰ˆæœ¬æ¸…å–®å¾©åŸå›ä¾†ï¼‰ã€‚");
      if(!ok) return;

      p.title = v.title || p.title;
      p.status = v.status || p.status;
      p.settings = JSON.parse(JSON.stringify(v.settings || {}));
      p.coverDataUrl = v.coverDataUrl || "";
      p.markdown = v.markdown || "";
      p.updatedAt = Date.now();

      saveState();
      loadPostToEditor(state.currentId);
      renderPostList();
      updateToc();
      refreshSaveState("å·²å¾©åŸ");
    }

    function previewVersion(idx){
      const p = state.posts[state.currentId];
      if(!p) return;
      const v = (p.versions || [])[idx];
      if(!v) return;

      document.getElementById("readerMask").style.display = "flex";
      document.getElementById("readerStatus").textContent = "ç‰ˆæœ¬é è¦½";

      document.getElementById("readerTitle").textContent = v.title || "ï¼ˆæœªå‘½åï¼‰";
      const meta = [
        `ç‰ˆæœ¬ï¼š${new Date(v.ts).toLocaleString()}`,
        `ç‹€æ…‹ï¼š${v.status === "published" ? "å·²ç™¼ä½ˆ" : "è‰ç¨¿"}`,
        v.settings?.slug ? `Slugï¼š${v.settings.slug}` : "",
        v.settings?.tags ? `Tagsï¼š${v.settings.tags}` : "",
        v.settings?.desc ? `æ‘˜è¦ï¼š${v.settings.desc}` : "",
      ].filter(Boolean).join(" ï½œ ");
      document.getElementById("readerMeta").textContent = meta;

      const coverWrap = document.getElementById("readerCover");
      if(v.coverDataUrl){
        coverWrap.style.display = "block";
        coverWrap.innerHTML = `<img src="${v.coverDataUrl}" alt="cover">`;
      }else{
        coverWrap.style.display = "none";
        coverWrap.innerHTML = "";
      }

      if(editor){
        const curMd = editor.getMarkdown();
        editor.setMarkdown(v.markdown || "", false);
        const html = editor.getHTML();
        editor.setMarkdown(curMd, false);
        editor.changeMode(state.ui.mode, true);
        document.getElementById("readerContent").innerHTML = html;
      }else{
        document.getElementById("readerContent").textContent = (v.markdown || "");
      }
    }

    function rollbackTo10Min(){
      const p = state.posts[state.currentId];
      if(!p) return;

      const target = Date.now() - 10*60*1000;
      const vs = (p.versions || []).slice().sort((a,b)=>b.ts-a.ts);

      const v = vs.find(x => x.ts <= target);
      if(!v){
        alert("æ‰¾ä¸åˆ° 10 åˆ†é˜å‰çš„ç‰ˆæœ¬ï¼ˆå¯èƒ½é‚„æ²’ç´¯ç©åˆ°ï¼Œæˆ–ä½ å‰›é–‹å§‹å¯«ï¼‰ã€‚ä½ å¯ä»¥å…ˆæ‰‹å‹•å»ºç«‹ç‰ˆæœ¬ã€‚");
        return;
      }

      const idx = (p.versions || []).findIndex(x => x.hash === v.hash);
      if(idx >= 0) restoreVersion(idx);
    }

    // =============================
    // Import/Export JSON
    // =============================
    function exportAllJson(){
      const p = state.posts[state.currentId];
      if(p && editor){
        p.markdown = editor.getMarkdown();
        p.updatedAt = Date.now();
      }
      saveState();
      const data = JSON.stringify(state, null, 2);
      downloadText(data, `blog_editor_backup_${new Date().toISOString().slice(0,10)}.json`, "application/json;charset=utf-8");
    }

    function importJsonFile(file){
      const r = new FileReader();
      r.onload = () => {
        try{
          const incoming = JSON.parse(String(r.result || "{}"));
          if(!incoming || typeof incoming !== "object" || !incoming.posts){
            alert("é€™ä»½ JSON æ ¼å¼ä¸å°ï¼ŒåŒ¯å…¥å¤±æ•—ã€‚");
            return;
          }

          const mode = confirm("è¦ç”¨ã€Œåˆä½µã€æ–¹å¼åŒ¯å…¥å—ï¼Ÿ\n\nç¢ºå®š = åˆä½µï¼ˆä¿ç•™ä½ ç¾æœ‰çš„æ–‡ç« ï¼‰\nå–æ¶ˆ = è¦†è“‹ï¼ˆç”¨åŒ¯å…¥è³‡æ–™å–ä»£ä½ ç›®å‰æ‰€æœ‰è³‡æ–™ï¼‰");

          if(mode){
            mergeState(incoming);
          }else{
            localStorage.setItem(LS_KEY, JSON.stringify(incoming));
          }

          location.reload();
        }catch(e){
          alert("è®€å– JSON å¤±æ•—ï¼Œå¯èƒ½æª”æ¡ˆå£æ‰æˆ–ä¸æ˜¯ JSONã€‚");
        }
      };
      r.readAsText(file, "utf-8");
    }

    function mergeState(incoming){
      const merged = loadState();
      merged.ui = merged.ui || state.ui;

      const existIds = new Set(Object.keys(merged.posts || {}));
      const incomingPosts = incoming.posts || {};

      for(const [id, post] of Object.entries(incomingPosts)){
        let newId = id;
        while(existIds.has(newId)){
          newId = newId + "_" + Math.random().toString(36).slice(2,6);
        }
        existIds.add(newId);
        merged.posts[newId] = post;
      }

      merged.ui = state.ui;
      const ids = Object.keys(merged.posts);
      merged.currentId = ids.sort((a,b)=>(merged.posts[b].updatedAt||0)-(merged.posts[a].updatedAt||0))[0] || merged.currentId;

      localStorage.setItem(LS_KEY, JSON.stringify(merged));
    }

    function downloadText(text, filename, mime){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =============================
    // UI bindings
    // =============================
    function bindUI(){
      // tabs filter
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          currentFilter = tab.dataset.filter || "all";
          renderPostList();
        });
      });

      // title sync
      const titleInput = document.getElementById("titleInput");
      titleInput.addEventListener("input", () => {
        const p = state.posts[state.currentId];
        if(!p) return;
        p.title = titleInput.value;
        p.updatedAt = Date.now();
        saveState();
        renderPostList();
        refreshSaveState("å·²å„²å­˜");
      });

      // âœ… å…¬é–‹é  + è¤‡è£½é€£çµ
      document.getElementById("btnOpenPublic").addEventListener("click", goPublicOfCurrent);
      document.getElementById("btnCopyPublic").addEventListener("click", copyPublicOfCurrent);
      document.getElementById("btnBackToEdit").addEventListener("click", () => { location.hash = "#/edit"; });
      document.getElementById("btnCopyPublicTop").addEventListener("click", () => {
        const h = location.hash || "";
        if(!h.startsWith("#/p/")) return;
        copyText(location.href, "å·²è¤‡è£½å…¬é–‹é€£çµ");
      });

      // new / delete
      document.getElementById("btnNew").addEventListener("click", () => {
        const id = newId();
        state.posts[id] = {
          title: "æœªå‘½åæ–‡ç« ",
          status: "draft",
          markdown: "",
          settings: { slug:"", tags:"", desc:"" },
          coverDataUrl: "",
          updatedAt: Date.now(),
          versions: [],
          lastAutoVerAt: 0,
          lastAutoHash: ""
        };
        state.currentId = id;
        saveState();
        location.hash = "#/edit";
        renderPostList();
        loadPostToEditor(id);
        updateToc();
      });

      document.getElementById("btnDelete").addEventListener("click", () => {
        const ids = Object.keys(state.posts);
        if(ids.length <= 1){
          alert("è‡³å°‘è¦ä¿ç•™ 1 ç¯‡æ–‡ç« å–”ï¼");
          return;
        }
        const cur = state.posts[state.currentId];
        const ok = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${cur?.title || "æœªå‘½å"}ã€ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰`);
        if(!ok) return;

        delete state.posts[state.currentId];
        const nextId = Object.keys(state.posts)
          .sort((a,b)=>(state.posts[b].updatedAt||0)-(state.posts[a].updatedAt||0))[0];
        state.currentId = nextId;
        saveState();
        renderPostList();
        loadPostToEditor(nextId);
        updateToc();
      });

      // status toggle
      document.getElementById("btnToggleStatus").addEventListener("click", () => {
        const p = state.posts[state.currentId];
        if(!p) return;
        p.status = (p.status === "published") ? "draft" : "published";
        p.updatedAt = Date.now();
        saveState();
        syncStatusButton();
        renderPostList();
        refreshSaveState("å·²å„²å­˜");
      });

      // font/size
      document.getElementById("fontSelect").addEventListener("change", (e) => {
        state.ui.fontFamily = e.target.value;
        saveState();
        applyUiVars();
      });
      document.getElementById("btnSmaller").addEventListener("click", () => setFontSize(state.ui.fontSize - 1));
      document.getElementById("btnBigger").addEventListener("click", () => setFontSize(state.ui.fontSize + 1));

      // mode
      document.getElementById("btnMode").addEventListener("click", () => {
        if(!editor) return;
        const next = editor.isMarkdownMode() ? "wysiwyg" : "markdown";
        state.ui.mode = next;
        saveState();
        editor.changeMode(next, false);
        setModeButtonText();
      });

      // theme toggle (re-mount)
      document.getElementById("btnTheme").addEventListener("click", () => {
        if(!editor) return;
        const md = editor.getMarkdown();
        state.ui.mode = editor.isMarkdownMode() ? "markdown" : "wysiwyg";

        state.ui.theme = (state.ui.theme === "dark") ? "light" : "dark";
        saveState();
        applyUiVars();

        mountEditor(state.ui.theme);
        editor.setMarkdown(md, false);
        editor.changeMode(state.ui.mode, true);
        setModeButtonText();
        updateToc();

        // å¦‚æœæ­£åœ¨å…¬é–‹é ï¼Œä¹Ÿæœƒè·Ÿè‘—æ›ä¸»é¡Œ
        handleRoute();
      });

      // reading
      document.getElementById("btnReading").addEventListener("click", () => {
        document.getElementById("readerMask").style.display = "flex";
        refreshReaderContent();
      });
      document.getElementById("btnCloseReader").addEventListener("click", () => {
        document.getElementById("readerMask").style.display = "none";
      });
      document.getElementById("btnRefreshReader").addEventListener("click", () => {
        document.getElementById("readerStatus").textContent = "æ›´æ–°ä¸­â€¦";
        refreshReaderContent();
      });

      // settings drawer
      document.getElementById("btnSettings").addEventListener("click", openDrawer);
      document.getElementById("btnCloseDrawer").addEventListener("click", closeDrawer);
      document.getElementById("drawerMask").addEventListener("click", (e) => {
        if(e.target.id === "drawerMask") closeDrawer();
      });
      document.getElementById("btnSaveSettings").addEventListener("click", saveSettings);

      // cover box
      const coverBox = document.getElementById("coverBox");
      const coverInput = document.getElementById("coverInput");

      document.getElementById("btnPickCover").addEventListener("click", () => coverInput.click());
      coverBox.addEventListener("click", (e) => {
        if(e.target && e.target.tagName === "BUTTON") return;
        coverInput.click();
      });

      coverInput.addEventListener("change", async () => {
        const file = coverInput.files && coverInput.files[0];
        if(!file) return;
        const dataUrl = await loadImageFromFile(file);
        await setCoverDataUrl(dataUrl);
        coverInput.value = "";
      });

      document.getElementById("btnRemoveCover").addEventListener("click", async (e) => {
        e.stopPropagation();
        await setCoverDataUrl("");
      });

      ["dragenter","dragover"].forEach(evt => {
        coverBox.addEventListener(evt, (e) => {
          e.preventDefault();
          coverBox.classList.add("drag");
        });
      });
      ["dragleave","drop"].forEach(evt => {
        coverBox.addEventListener(evt, (e) => {
          e.preventDefault();
          coverBox.classList.remove("drag");
        });
      });
      coverBox.addEventListener("drop", async (e) => {
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!file) return;
        const dataUrl = await loadImageFromFile(file);
        await setCoverDataUrl(dataUrl);
      });

      coverBox.addEventListener("paste", async (e) => {
        const items = e.clipboardData && e.clipboardData.items;
        if(!items) return;
        for(const it of items){
          if(it.type && it.type.startsWith("image/")){
            const file = it.getAsFile();
            if(file){
              const dataUrl = await loadImageFromFile(file);
              await setCoverDataUrl(dataUrl);
              e.preventDefault();
              break;
            }
          }
        }
      });

      // Share overlay
      document.getElementById("btnShare").addEventListener("click", () => {
        document.getElementById("shareMask").style.display = "flex";
      });
      document.getElementById("btnCloseShare").addEventListener("click", () => {
        document.getElementById("shareMask").style.display = "none";
      });
      document.getElementById("btnBuildShare").addEventListener("click", async () => {
        const url = await buildShare("1200x630");
        if(!url) return;
        showSharePreview(url);
      });

      function showSharePreview(dataUrl){
        const img = document.getElementById("shareImg");
        const empty = document.getElementById("shareEmpty");
        img.src = dataUrl;
        img.style.display = "block";
        empty.style.display = "none";
      }

      async function downloadShare(size){
        const url = await buildShare(size);
        if(!url) return;
        showSharePreview(url);
        downloadDataUrl(url, `share_${size}_${safeFileName(state.posts[state.currentId]?.title || "untitled")}.png`);
      }

      document.getElementById("btnDl1").addEventListener("click", () => downloadShare("1200x630"));
      document.getElementById("btnDl2").addEventListener("click", () => downloadShare("1080x1080"));
      document.getElementById("btnDl3").addEventListener("click", () => downloadShare("1080x1350"));

      // Versions overlay
      document.getElementById("btnVersions").addEventListener("click", () => {
        document.getElementById("verMask").style.display = "flex";
        renderVersions();
      });
      document.getElementById("btnCloseVer").addEventListener("click", () => {
        document.getElementById("verMask").style.display = "none";
      });
      document.getElementById("btnSaveVer").addEventListener("click", () => {
        const p = state.posts[state.currentId];
        if(!p) return;
        pushVersion(p, {note:"manual"});
        p.updatedAt = Date.now();
        saveState();
        renderVersions();
        refreshSaveState("å·²å„²å­˜ç‰ˆæœ¬");
      });
      document.getElementById("btnRollback10").addEventListener("click", rollbackTo10Min);

      // Commands overlay
      document.getElementById("btnCmds").addEventListener("click", () => {
        document.getElementById("cmdMask").style.display = "flex";
      });
      document.getElementById("btnCloseCmd").addEventListener("click", () => {
        document.getElementById("cmdMask").style.display = "none";
      });
      document.getElementById("btnInsertHelp").addEventListener("click", () => {
        if(!editor) return;
        editor.insertText(buildHelpBlock());
        document.getElementById("cmdMask").style.display = "none";
        scheduleAutoSave();
      });

      // Export / Import JSON
      document.getElementById("btnExportJson").addEventListener("click", exportAllJson);
      document.getElementById("btnImportJson").addEventListener("click", () => {
        document.getElementById("jsonInput").click();
      });
      document.getElementById("jsonInput").addEventListener("change", () => {
        const f = document.getElementById("jsonInput").files && document.getElementById("jsonInput").files[0];
        if(f) importJsonFile(f);
        document.getElementById("jsonInput").value = "";
      });
    }

    function setFontSize(n){
      const next = Math.max(12, Math.min(24, Number(n)));
      state.ui.fontSize = next;
      saveState();
      applyUiVars();
    }

    function setModeButtonText(){
      const b = document.getElementById("btnMode");
      if(!editor){ b.textContent = "Markdown"; return; }
      b.textContent = editor.isMarkdownMode() ? "Markdown" : "WYSIWYG";
    }

    // Drawer open/close/save
    function openDrawer(){
      const p = state.posts[state.currentId];
      if(p){
        document.getElementById("settingSlug").value = (p.settings?.slug || "");
        document.getElementById("settingTags").value = (p.settings?.tags || "");
        document.getElementById("settingDesc").value = (p.settings?.desc || "");
        syncCoverPreview();
      }
      document.getElementById("drawerMask").style.display = "flex";
    }

    function closeDrawer(){
      document.getElementById("drawerMask").style.display = "none";
    }

    function saveSettings(){
      const p = state.posts[state.currentId];
      if(!p) return;

      p.settings = p.settings || {};
      p.settings.slug = document.getElementById("settingSlug").value.trim();
      p.settings.tags = document.getElementById("settingTags").value.trim();
      p.settings.desc = document.getElementById("settingDesc").value.trim();
      p.updatedAt = Date.now();

      saveState();
      closeDrawer();
      refreshSaveState("å·²å„²å­˜");
    }

    // =============================
    // Utilities
    // =============================
    function refreshSaveState(text){
      document.getElementById("saveState").textContent = text;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function safeFileName(s){
      return String(s).trim().replace(/[\\/:*?"<>|]+/g, "_").slice(0, 60) || "untitled";
    }

    function debounce(fn, wait){
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  </script>
</body>
</html>
